{% extends "base.html" %}

{% block title %}Editar Apuração{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1>Editar Apuração</h1>
        <p class="page-description">
            {% if apuracao %}
                Editando apuração de {{ apuracao.mes_nome }}/{{ apuracao.ano }}
            {% else %}
                Crie uma nova apuração mensal com verbas e cálculos
            {% endif %}
        </p>
    </div>

    <div class="form-container">
        <form method="POST" class="apuracao-form" id="apuracaoForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <!-- Período -->
            <div class="form-section">
                <h3>Período</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="mes">Mês:</label>
                        <select name="mes" id="mes" class="form-control" required>
                            {% for i in range(1, 13) %}
                                {% set mes_nome = ['', 'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                                                  'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][i] %}
                                <option value="{{ i }}" {% if apuracao and apuracao.mes == i %}selected{% endif %}>
                                    {{ mes_nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ano">Ano:</label>
                        <input type="number" 
                               name="ano" 
                               id="ano" 
                               class="form-control" 
                               value="{{ apuracao.ano if apuracao else '' }}"
                               {% if apuracao %}readonly{% endif %}
                               min="2020" 
                               max="2100" 
                               required>
                    </div>
                </div>
            </div>

            <!-- Dados Financeiros Básicos -->
            <div class="form-section">
                <h3>Dados Financeiros</h3>
                <p class="info-text"><i class="bi bi-lightbulb icon-text"></i> Os valores são calculados automaticamente baseados nos pedidos pagos do período selecionado.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="receita">Receita:</label>
                        <small class="help-text">Receita total do período</small>
                        <input type="text" 
                               name="receita" 
                               id="receita" 
                               class="form-control currency-input" 
                               data-requer-centavos="true"
                               value="{{ dados.receita if dados else (apuracao.receita if apuracao else '') }}"
                               step="0.01" 
                               min="0"
                               oninput="calcularResultados()">
                    </div>
                    <div class="form-group">
                        <label for="cpv">CPV (Custo dos Produtos Vendidos):</label>
                        <small class="help-text">Custo dos produtos vendidos no período</small>
                        <input type="text" 
                               name="cpv" 
                               id="cpv" 
                               class="form-control currency-input" 
                               data-requer-centavos="true"
                               value="{{ dados.cpv if dados else (apuracao.cpv if apuracao else '') }}"
                               step="0.01" 
                               min="0"
                               oninput="calcularResultados()">
                    </div>
                </div>
            </div>

            <!-- Verbas e Outros Dados -->
            <div class="form-section">
                <h3>Verbas e Outros Dados</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="verba_scann">Verba SCANN:</label>
                        <small class="help-text">Valor da verba SCANN do período</small>
                        <input type="text" 
                               name="verba_scann" 
                               id="verba_scann" 
                               class="form-control currency-input" 
                               data-requer-centavos="true"
                               value="{{ dados.verba_scann if dados else (apuracao.verba_scann if apuracao else '') }}"
                               step="0.01" 
                               min="0"
                               oninput="calcularResultados()">
                    </div>
                    <div class="form-group">
                        <label for="verba_plano_negocios">Verba Plano de Negócios:</label>
                        <small class="help-text">Valor da verba de Plano de Negócios</small>
                        <input type="text" 
                               name="verba_plano_negocios" 
                               id="verba_plano_negocios" 
                               class="form-control currency-input" 
                               data-requer-centavos="true"
                               value="{{ dados.verba_plano_negocios if dados else (apuracao.verba_plano_negocios if apuracao else '') }}"
                               step="0.01" 
                               min="0"
                               oninput="calcularResultados()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="verba_time_ambev">Verba Time Ambev:</label>
                        <small class="help-text">Valor da verba Time Ambev</small>
                        <input type="text" 
                               name="verba_time_ambev" 
                               id="verba_time_ambev" 
                               class="form-control currency-input" 
                               data-requer-centavos="true"
                               value="{{ dados.verba_time_ambev if dados else (apuracao.verba_time_ambev if apuracao else '') }}"
                               step="0.01" 
                               min="0"
                               oninput="calcularResultados()">
                    </div>
                    <div class="form-group">
                        <label for="verba_outras_receitas">Outras verbas:</label>
                        <small class="help-text">Outras receitas do período</small>
                        <input type="text" 
                               name="verba_outras_receitas" 
                               id="verba_outras_receitas" 
                               class="form-control currency-input" 
                               data-requer-centavos="true"
                               value="{{ dados.verba_outras_receitas if dados else (apuracao.verba_outras_receitas if apuracao else '') }}"
                               step="0.01" 
                               min="0"
                               oninput="calcularResultados()">
                    </div>
                </div>
                <div class="form-row single-col">
                    <div class="form-group">
                        <label for="outros_custos">Outros custos:</label>
                        <small class="help-text">Custos adicionais do período</small>
                        <input type="text" 
                               name="outros_custos" 
                               id="outros_custos" 
                               class="form-control currency-input" 
                               data-requer-centavos="true"
                               value="{{ dados.outros_custos if dados else (apuracao.outros_custos if apuracao else '') }}"
                               step="0.01" 
                               min="0"
                               oninput="calcularResultados()">
                    </div>
                </div>
            </div>

            <!-- Resumo dos Cálculos -->
            <div class="form-section">
                <h3>Resumo dos Resultados</h3>
                <div class="calculations-grid">
                    <div class="calc-item">
                        <span class="calc-label">Margem Bruta:</span>
                        <span class="calc-value" id="margemBruta">R$ 0,00</span>
                    </div>
                    <div class="calc-item">
                        <span class="calc-label">Total Verbas:</span>
                        <span class="calc-value" id="totalVerbas">R$ 0,00</span>
                    </div>
                    <div class="calc-item">
                        <span class="calc-label">Resultado Líquido:</span>
                        <span class="calc-value" id="resultadoLiquido">R$ 0,00</span>
                    </div>
                    <div class="calc-item">
                        <span class="calc-label">% Margem:</span>
                        <span class="calc-value" id="percentualMargem">0,0%</span>
                    </div>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="form-actions">
                <a href="{{ url_for('apuracao.listar_apuracao') }}" class="btn-secondary">Cancelar</a>
                <button type="submit" class="btn-primary">
                    {% if apuracao %}Atualizar{% else %}Criar{% endif %} Apuração
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.form-container {
    background: var(--neo-background);
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--neo-outset-shadow);
    max-width: 800px;
    margin: 0 auto;
}

.form-section {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-light);
}

.form-section:last-of-type {
    border-bottom: none;
}

.form-section h3 {
    margin-bottom: 1rem;
    color: var(--text-primary);
    font-size: 1.2rem;
    font-weight: 600;
}

.info-text {
    background: rgba(107, 70, 193, 0.1);
    color: var(--color-primary);
    padding: 1rem;
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
    border-left: 4px solid var(--color-primary);
    font-size: 0.9rem;
}

.help-text {
    color: var(--text-secondary);
    font-size: 0.8rem;
    display: block;
    margin-bottom: 0.3rem;
    font-style: italic;
}

.periodo-info {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.3);
    border-radius: var(--border-radius);
    padding: 1rem;
    margin-top: 1rem;
}

.periodo-info h4 {
    margin: 0 0 0.5rem 0;
    color: #28a745;
    font-size: 1rem;
}

.periodo-info p {
    margin: 0.3rem 0;
    font-size: 0.9rem;
    color: var(--text-primary);
}

.readonly-field {
    background-color: #f8f9fa !important;
    color: var(--text-secondary) !important;
    cursor: not-allowed !important;
    border: 1px solid #dee2e6 !important;
}

.readonly-field:focus {
    box-shadow: none !important;
    border-color: #dee2e6 !important;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}
.form-row.single-col {
    grid-template-columns: 1fr;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-group label {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.currency-input {
    text-align: right;
    font-family: 'Monaco', 'Consolas', monospace;
}

.calculations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.calc-item {
    background: var(--neo-background);
    padding: 1rem;
    border-radius: var(--border-radius);
    box-shadow: var(--neo-inset-shadow);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.calc-label {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.calc-value {
    font-weight: 700;
    color: var(--text-primary);
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 1rem;
}

.calc-value.positive {
    color: var(--success-color);
}

.calc-value.negative {
    color: var(--danger-color);
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-light);
}

</style>
<script nonce="{{ nonce }}">
function parseCurrencyInput(id) {
    const field = document.getElementById(id);
    if (!field) return 0;
    const rawValue = (field.value || '').trim();
    if (!rawValue) return 0;
    if (typeof parseCurrencyBRL === 'function') {
        return parseCurrencyBRL(rawValue);
    }
    const normalized = rawValue
        .replace(/[^\d,.-]/g, '')
        .replace(/\./g, '')
        .replace(',', '.');
    const parsed = Number(normalized);
    return Number.isFinite(parsed) ? parsed : 0;
}

function calcularResultados() {
    const receita = parseCurrencyInput('receita');
    const cpv = parseCurrencyInput('cpv');
    const verbaScann = parseCurrencyInput('verba_scann');
    const verbaPlanoNegocios = parseCurrencyInput('verba_plano_negocios');
    const verbaTimeAmbev = parseCurrencyInput('verba_time_ambev');
    const verbaOutras = parseCurrencyInput('verba_outras_receitas');
    const outrosCustos = parseCurrencyInput('outros_custos');

    // Cálculos
    const totalVerbas = verbaScann + verbaPlanoNegocios + verbaTimeAmbev + verbaOutras;
    const margemBruta = receita - cpv;
    const resultadoLiquido = margemBruta + totalVerbas - outrosCustos;
    const percentualCalculado = receita > 0 ? (margemBruta / receita) * 100 : 0;

    // Atualizar display
    document.getElementById('margemBruta').textContent = formatCurrency(margemBruta);
    document.getElementById('totalVerbas').textContent = formatCurrency(totalVerbas);
    document.getElementById('resultadoLiquido').textContent = formatCurrency(resultadoLiquido);
    document.getElementById('percentualMargem').textContent = percentualCalculado.toFixed(1) + '%';

    // Aplicar classes de cor
    const margemEl = document.getElementById('margemBruta');
    const resultadoEl = document.getElementById('resultadoLiquido');
    const percentualEl = document.getElementById('percentualMargem');

    // Reset classes
    [margemEl, resultadoEl, percentualEl].forEach(el => {
        el.classList.remove('positive', 'negative');
    });

    // Aplicar cores baseadas nos valores
    margemEl.classList.add(margemBruta >= 0 ? 'positive' : 'negative');
    resultadoEl.classList.add(resultadoLiquido >= 0 ? 'positive' : 'negative');
    percentualEl.classList.add(percentualCalculado >= 0 ? 'positive' : 'negative');
}

function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);
}

// Calcular resultados na carga da página
document.addEventListener('DOMContentLoaded', function() {
    calcularResultados();
});
</script>
{% endblock %}
