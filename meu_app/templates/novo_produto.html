{% extends 'base.html' %}

{% block title %}{% if produto %}Editar Produto{% else %}Novo Produto{% endif %}{% endblock %}

{% block page_title %}{% if produto %}Editar Produto{% else %}Novo Produto{% endif %}{% endblock %}

{% block content %}
<div class="card" style="max-width: 600px; margin: 0 auto;">
    <h2>{% if produto %}<i class="bi bi-pencil icon-text"></i> Editar Produto{% else %}<i class="bi bi-plus-lg icon-text"></i> Novo Produto{% endif %}</h2>
    
    <form method="POST" id="formProduto">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <div class="form-group">
            <label for="nome">Nome *</label>
            <input type="text" 
                   id="nome" 
                   name="nome" 
                   value="{{ produto.nome if produto else '' }}" 
                   required 
                   class="form-control">
        </div>

        <div class="form-group">
            <label for="categoria">Categoria *</label>
            {% set categorias_opts = categorias or ['CERVEJA', 'NAB', 'OUTROS'] %}
            {% if produto and produto.categoria and produto.categoria not in categorias_opts %}
                {% set categorias_opts = [produto.categoria] + categorias_opts %}
            {% endif %}
            <select id="categoria" name="categoria" required class="form-control">
                <option value="">Selecione uma categoria</option>
                {% for cat in categorias_opts %}
                <option value="{{ cat }}" {% if produto and produto.categoria == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>
            <small class="text-muted">Lista gerada a partir das categorias existentes.</small>
        </div>

        <div class="form-group">
            <label for="codigo_interno">Código Interno</label>
            <input type="text" 
                   id="codigo_interno" 
                   name="codigo_interno" 
                   value="{{ produto.codigo_interno if produto else '' }}"
                   class="form-control">
        </div>

        <div class="form-group">
            <label for="ean">EAN/Código de Barras</label>
            <input type="text" 
                   id="ean" 
                   name="ean" 
                   value="{{ produto.ean if produto else '' }}"
                   class="form-control"
                   placeholder="Ex: 7891234567890">
        </div>

        <div class="d-flex gap-2 justify-content-between mt-4">
            <a href="{{ url_for('produtos.listar_produtos') }}" class="btn btn-secondary"><i class="bi bi-arrow-left icon-text"></i> Voltar</a>
            <button type="submit" class="btn btn-success" id="btnSalvar">
                <i class="bi bi-save icon-text"></i> Salvar Produto
            </button>
        </div>
    </form>
</div>

<script nonce="{{ nonce }}">
// Prevenir double-submit
document.getElementById('formProduto').addEventListener('submit', function(e) {
    const btnSalvar = document.getElementById('btnSalvar');
    if (btnSalvar.disabled) {
        e.preventDefault();
        return false;
    }
    
    // Desabilitar botão após submit
    btnSalvar.disabled = true;
    btnSalvar.innerHTML = 'Salvando...';
    
    // Re-habilitar após 3 segundos (caso haja erro e página não redirecione)
    setTimeout(function() {
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = 'Salvar Produto';
    }, 3000);
});
</script>
{% endblock %}
