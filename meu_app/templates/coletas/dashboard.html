{% extends 'base.html' %}

{% block title %}Dashboard Coletas{% endblock %}

{% block page_title %}Dashboard Coletas{% endblock %}

{% block content %}
<div class="card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="bi bi-box-seam icon-text"></i> Operações de Coleta</h2>
    </div>

    {% if pedidos %}
        <div class="table-toolbar mb-3">
            <div class="input-group shadow-sm" style="max-width: 360px;">
                <span class="input-group-text bg-white">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="search" id="filtroColetas" class="form-control" placeholder="Buscar por cliente ou pedido..." />
            </div>
            <small class="text-muted">Clique nos cabeçalhos para ordenar e use a busca para filtrar rapidamente.</small>
        </div>
        <div class="table-responsive">
            <table class="coletas-table">
                <thead>
                    <tr>
                        <th data-column-index="0" class="text-center">Cliente</th>
                        <th data-column-index="1" class="text-center">Pedidos</th>
                        <th data-column-index="2" class="text-center">Data da última coleta</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in pedidos %}
                        <tr class="coleta-row" data-details-id="">
                            <td>{{ item.cliente_nome }}</td>
                            <td>
                                <div class="d-flex flex-wrap gap-1 justify-content-center">
                                    {% for pedido_id in item.pedidos_ids %}
                                        <span class="badge bg-light text-dark">#{{ pedido_id }}</span>
                                    {% endfor %}
                                </div>
                            </td>
                            <td>
                                {% set data_ref = item.data_mais_recente or (item.pedido.data if item.pedido and item.pedido.data else None) %}
                                {{ data_ref.strftime('%d/%m/%Y') if data_ref else '-' }}
                            </td>
                            <td>
                                {% set processar_base = url_for('coletas.processar_coleta', pedido_id=0).rsplit('/', 1)[0] %}
                                {% set historico_base = url_for('coletas.historico_coletas', pedido_id=0).rsplit('/', 1)[0] %}
                                <div class="action-buttons"
                                     data-processar-base="{{ processar_base }}"
                                     data-historico-base="{{ historico_base }}">
                                    <div class="pedido-selector">
                                        <label for="pedido-select-{{ loop.index }}" class="visually-hidden">Selecione o pedido</label>
                                        <select class="form-select form-select-sm pedido-select" id="pedido-select-{{ loop.index }}">
                                            {% for pedido_id in item.pedidos_ids %}
                                                <option value="{{ pedido_id }}">Pedido #{{ pedido_id }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="d-flex flex-wrap gap-1 justify-content-center">
                                        {% if not item.coletado_completo %}
                                            <button type="button"
                                                    class="btn btn-sm btn-primary btn-acao-coleta"
                                                    title="Processar coleta do pedido selecionado">
                                                <i class="bi bi-box-seam"></i> COLETAR
                                            </button>
                                        {% endif %}
                                        {% if item.itens_coletados > 0 %}
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-success btn-acao-historico"
                                                    title="Histórico do pedido selecionado">
                                                <i class="bi bi-clock-history"></i> HISTÓRICO
                                            </button>
                                        {% endif %}
                                        <button type="button"
                                                class="btn btn-sm btn-dark btn-quant-pendente"
                                                data-pedidos="{{ item.pedidos_ids | join(',') }}"
                                                data-cliente="{{ item.cliente_nome }}">
                                            <i class="bi bi-exclamation-circle"></i> QUANT. PENDENTE
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">
                {% if filtro == 'coletados' %}
                    Nenhum pedido coletado encontrado
                {% elif filtro == 'pendentes' %}
                    Nenhum pedido pendente de coleta
                {% else %}
                    Nenhum pedido encontrado
                {% endif %}
            </h4>
            <p class="text-muted">
                {% if filtro == 'pendentes' %}
                    Todos os pedidos já foram coletados ou não há pedidos com pagamento aprovado.
                {% else %}
                    Não há dados para exibir com o filtro selecionado.
                {% endif %}
            </p>
        </div>
    {% endif %}
</div>

<div class="modal fade" id="modalPendencias" tabindex="-1" aria-labelledby="modalPendenciasLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPendenciasLabel">Pendências de Produtos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted" id="modalPendenciasCliente"></p>
                <div id="pendenciasFeedback" class="alert alert-info d-none"></div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th class="text-center">Quantidade pendente</th>
                            </tr>
                        </thead>
                        <tbody id="pendenciasBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block styles %}
<style>
    .table-toolbar {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .coletas-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .coletas-table th,
    .coletas-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f4;
        text-align: center;
    }

    .coletas-table th {
        background: #f8f9fa;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .coletas-table tr:hover {
        background: #f8fbff;
    }

    .coletas-table th[data-column-index] {
        cursor: pointer !important;
        user-select: none;
        position: relative;
    }

    .coletas-table th[data-column-index] .sort-indicator {
        font-size: 0.7rem;
        margin-left: 6px;
        color: #adb5bd;
    }

    .coletas-table th.sorted-asc,
    .coletas-table th.sorted-desc {
        color: #0d6efd;
    }

    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
    }

    .action-buttons .btn {
        border-radius: 8px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
    }

    .pedido-selector {
        width: 100%;
        max-width: 220px;
    }

    .pedido-selector select {
        font-size: 0.9rem;
    }

    .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script nonce="{{ nonce }}">
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.action-buttons').forEach((container) => {
        const select = container.querySelector('.pedido-select');
        if (!select) return;

        const processarBase = container.dataset.processarBase;
        const historicoBase = container.dataset.historicoBase;

        const resolveUrl = (base, id) => {
            if (!base || !id) return null;
            return `${base}/${id}`;
        };

        const coletarBtn = container.querySelector('.btn-acao-coleta');
        if (coletarBtn) {
            coletarBtn.addEventListener('click', () => {
                const pedidoId = select.value;
                const url = resolveUrl(processarBase, pedidoId);
                if (url) window.location.href = url;
            });
        }

        const historicoBtn = container.querySelector('.btn-acao-historico');
        if (historicoBtn) {
            historicoBtn.addEventListener('click', () => {
                const pedidoId = select.value;
                const url = resolveUrl(historicoBase, pedidoId);
                if (url) window.location.href = url;
            });
        }
    });
});
</script>
<script nonce="{{ nonce }}">
document.addEventListener('DOMContentLoaded', () => {
    const tabela = document.querySelector('.coletas-table');
    if (!tabela) return;

    const tbody = tabela.querySelector('tbody');
    const headers = tabela.querySelectorAll('th[data-column-index]');
    const filtro = document.getElementById('filtroColetas');
    const pendenciasModalEl = document.getElementById('modalPendencias');
    const bootstrapLib = (typeof window !== 'undefined' && window.bootstrap)
        ? window.bootstrap
        : (typeof bootstrap !== 'undefined' ? bootstrap : null);
    const pendenciasModal = pendenciasModalEl && bootstrapLib ? new bootstrapLib.Modal(pendenciasModalEl) : null;
    const pendenciasBody = document.getElementById('pendenciasBody');
    const pendenciasFeedback = document.getElementById('pendenciasFeedback');
    const pendenciasCliente = document.getElementById('modalPendenciasCliente');
    const pendenciasEndpoint = "{{ url_for('coletas.pendencias_itens') }}";
    let currentSort = { index: null, direction: 'asc' };

    const parseValue = (cell, index) => {
        const text = cell.textContent.trim();
        if (index === 2) {
            if (!text.includes('/')) return text.toLowerCase();
            const [dia, mes, ano] = text.split('/');
            if (!dia || !mes || !ano) return text.toLowerCase();
            return `${ano}-${mes}-${dia}`;
        }
        return text.toLowerCase();
    };

    const applySortIndicators = () => {
        headers.forEach((header) => {
            header.classList.remove('sorted-asc', 'sorted-desc');
            let indicator = header.querySelector('.sort-indicator');
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.className = 'sort-indicator';
                header.appendChild(indicator);
            }
            indicator.innerHTML = '';
        });
        const target = headers[currentSort.index];
        if (!target) return;
        let indicator = target.querySelector('.sort-indicator');
        if (!indicator) {
            indicator = document.createElement('span');
            indicator.className = 'sort-indicator';
            target.appendChild(indicator);
        }
        target.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
        indicator.innerHTML = currentSort.direction === 'asc'
            ? '<i class="bi bi-caret-up-fill"></i>'
            : '<i class="bi bi-caret-down-fill"></i>';
    };

    const sortRows = (index, direction) => {
        const rows = Array.from(tbody.querySelectorAll('tr.coleta-row'));
        rows.sort((rowA, rowB) => {
            const a = parseValue(rowA.children[index], index);
            const b = parseValue(rowB.children[index], index);

            if (typeof a === 'number' && typeof b === 'number') {
                return direction === 'asc' ? a - b : b - a;
            }
            return direction === 'asc'
                ? String(a).localeCompare(String(b))
                : String(b).localeCompare(String(a));
        });

        rows.forEach((row) => tbody.appendChild(row));
        applySortIndicators();
    };

    headers.forEach((header, index) => {
        header.addEventListener('click', () => {
            const direction = (currentSort.index === index && currentSort.direction === 'asc') ? 'desc' : 'asc';
            currentSort = { index, direction };
            sortRows(index, direction);
        });
    });

    if (filtro) {
        filtro.addEventListener('input', (event) => {
            const termo = event.target.value.trim().toLowerCase();
            tbody.querySelectorAll('tr.coleta-row').forEach((row) => {
                const texto = row.textContent.toLowerCase();
                row.style.display = texto.includes(termo) ? '' : 'none';
            });
        });
    }

    const setPendenciasFeedback = (message = '', type = 'info') => {
        if (!pendenciasFeedback) return;
        pendenciasFeedback.classList.remove('alert-info', 'alert-warning', 'alert-danger', 'alert-success');
        if (!message) {
            pendenciasFeedback.classList.add('d-none');
            pendenciasFeedback.textContent = '';
            return;
        }
        pendenciasFeedback.textContent = message;
        pendenciasFeedback.classList.remove('d-none');
        pendenciasFeedback.classList.add(`alert-${type}`);
    };

    const renderPendencias = (itens) => {
        if (!pendenciasBody) {
            return;
        }
        pendenciasBody.innerHTML = '';
        if (!Array.isArray(itens) || itens.length === 0) {
            setPendenciasFeedback('Nenhum item pendente encontrado.', 'info');
            return;
        }
        setPendenciasFeedback('');
        itens.forEach((item) => {
            const row = document.createElement('tr');
            const produtoCell = document.createElement('td');
            produtoCell.textContent = item.produto;
            const quantidadeCell = document.createElement('td');
            quantidadeCell.className = 'text-center fw-bold';
            quantidadeCell.textContent = item.quantidade;
            row.appendChild(produtoCell);
            row.appendChild(quantidadeCell);
            pendenciasBody.appendChild(row);
        });
    };

    tabela.addEventListener('click', async (event) => {
        const button = event.target.closest('.btn-quant-pendente');
        if (!button) {
            return;
        }

        const pedidosRaw = (button.dataset.pedidos || '').split(',').map((value) => value.trim()).filter(Boolean);
        if (!pedidosRaw.length) {
            return;
        }
        const pedidoIds = [...new Set(pedidosRaw.map((id) => parseInt(id, 10)).filter((id) => !Number.isNaN(id)))];
        if (!pedidoIds.length) {
            return;
        }

        if (pendenciasCliente) {
            pendenciasCliente.textContent = `Cliente: ${button.dataset.cliente || 'N/A'}`;
        }
        setPendenciasFeedback('Carregando itens pendentes...', 'info');
        renderPendencias([]);

        try {
                const response = await fetch(pendenciasEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.CSRF_TOKEN,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ pedido_ids: pedidoIds })
                });

            const result = await response.json();
            if (!response.ok || !result.success) {
                throw new Error(result.error || 'Não foi possível carregar as pendências.');
            }

            renderPendencias(result.pendencias || []);
        } catch (error) {
            setPendenciasFeedback(error.message, 'danger');
            if (pendenciasBody) {
                pendenciasBody.innerHTML = '';
            }
        }

        if (pendenciasModal) {
            pendenciasModal.show();
        } else if (pendenciasModalEl) {
            pendenciasModalEl.classList.add('show');
            pendenciasModalEl.style.display = 'block';
            pendenciasModalEl.removeAttribute('aria-hidden');
        }
    });
});
</script>
{% endblock %}

