{% extends 'base.html' %}

{% block page_title %}Novo Pedido{% endblock %}

{% block content %}
<div class="card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0"><i class="bi bi-pencil-square icon-text"></i> Novo Pedido</h2>
        <a href="{{ url_for('pedidos.listar_pedidos') }}" class="btn btn-secondary"><i class="bi bi-arrow-left icon-text"></i> Voltar</a>
    </div>

    <form method="POST" id="formPedido" action="{{ url_for('pedidos.novo_pedido') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group mb-3">
            <label for="cliente_id" class="form-label">Cliente</label>
            <select name="cliente_id" class="form-control" required>
                {% for cliente in clientes %}
                    <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <hr>

        <h5>Itens do Pedido</h5>

        <div id="itens" class="item-container"></div>

        <button type="button" class="btn btn-info btn-sm mt-2" data-action="add-item" tabindex="-1"><i class="bi bi-plus-lg icon-text"></i> Adicionar Produto</button>
        
        
        <script nonce="{{ nonce }}">
            function adicionarItem() {
                console.log('[Pedidos] Adicionando produto...');
                
                const container = document.getElementById('itens');
                if (!container) {
                    alert('Erro: Container não encontrado');
                    return;
                }
                
                // Contar itens existentes
                const itemIndex = container.children.length;
                
                // Criar HTML do produto com select simples
                const produtoHTML = `
                    <div class="d-flex gap-2 mb-2 align-items-center" data-item-index="${itemIndex}" data-item-row>
                        <div class="flex-grow-1">
                            <select name="produto_id" class="form-control" required>
                                <option value="">Selecione um produto...</option>
                            </select>
                        </div>
                        <div style="width: 100px;">
                            <input type="number" name="quantidade" class="form-control" placeholder="Qtd" min="1" required>
                        </div>
                        <div style="width: 150px;">
                            <input type="text" name="preco_venda" class="form-control currency-input" placeholder="Preço Venda" data-currency="true" required>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm" data-action="remove-item" aria-label="Remover item" tabindex="-1"><i class="bi bi-trash icon-text"></i></button>
                    </div>
                `;
                
                // Adicionar ao container
                container.insertAdjacentHTML('beforeend', produtoHTML);
                
                console.log('[Pedidos] Produto adicionado. Total:', container.children.length);
                
                // Carregar produtos via AJAX
                carregarProdutosNoSelect(container.lastElementChild.querySelector('select'));
                
                // Aplicar formatação de moeda ao novo campo de preço
                const newPriceInput = container.lastElementChild.querySelector('input[name="preco_venda"]');
                if (newPriceInput && typeof CurrencyFormatter !== 'undefined') {
                    // Adicionar eventos de formatação
                    newPriceInput.addEventListener('input', () => {
                        CurrencyFormatter.formatInput(newPriceInput);
                    });
                }
            }
            
            // Função para carregar produtos via AJAX
            function carregarProdutosNoSelect(selectElement) {
                if (!selectElement) return;
                
                // Mostrar loading
                selectElement.innerHTML = '<option value="">Carregando produtos...</option>';
                
                // Fazer requisição AJAX
                fetch("{{ url_for('produtos.api_produtos') }}")
                    .then(response => response.json())
                    .then(data => {
                        // Limpar select
                        selectElement.innerHTML = '<option value="">Selecione um produto...</option>';
                        
                        // Adicionar produtos
                        if (data.results && data.results.length > 0) {
                            data.results.forEach(produto => {
                                const option = document.createElement('option');
                                option.value = produto.id;
                                option.textContent = produto.text;
                                selectElement.appendChild(option);
                            });
                        } else {
                            selectElement.innerHTML = '<option value="">Nenhum produto encontrado</option>';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar produtos:', error);
                        selectElement.innerHTML = '<option value="">Erro ao carregar produtos</option>';
                    });
            }
            
            // Função para confirmar pedido
            window.confirmarPedido = function() {
                console.log('[Pedidos] Função confirmarPedido executada!');
                try {
                    let resumo = "";
                    const cliente = document.querySelector('select[name="cliente_id"]');
                    console.log('[Pedidos] Cliente selecionado:', cliente ? cliente.options[cliente.selectedIndex].text : 'Nenhum');
                    resumo += `<p><strong>Cliente:</strong> ${cliente.options[cliente.selectedIndex].text}</p>`;

                    const itens = document.querySelectorAll('#itens > div');
                    if (itens.length === 0) {
                        alert('Adicione ao menos um produto antes de salvar o pedido.');
                        return;
                    }

                    resumo += "<h6>Itens:</h6><ul>";
                    let formValido = true;
                    itens.forEach(item => {
                        const produtoSelect = item.querySelector('select');
                        const quantidadeInput = item.querySelector('input[type="number"]');
                        const precoVendaInput = item.querySelector('input[type="text"]');

                        if (!produtoSelect.value || !quantidadeInput.value || !precoVendaInput.value) {
                            formValido = false;
                        }

                        let produtoNome = produtoSelect.options[produtoSelect.selectedIndex]?.text || 'Produto não selecionado';
                        const quantidade = quantidadeInput.value;
                        let precoFormatado = precoVendaInput.value;
                        
                        resumo += `<li>${produtoNome} - ${quantidade} un. - ${precoFormatado}</li>`;
                    });
                    resumo += "</ul>";

                    if (!formValido) {
                        alert('Preencha todos os campos de todos os itens.');
                        return;
                    }

                    document.getElementById('resumoPedido').innerHTML = resumo;
                    document.getElementById('modalConfirmacao').style.display = 'flex';
                } catch (error) {
                    console.error('Erro ao confirmar pedido:', error);
                    alert('Ocorreu um erro ao confirmar o pedido.');
                }
            }
            
            // Função para fechar modal
            window.fecharModal = function() {
                document.getElementById('modalConfirmacao').style.display = 'none';
            }
            
            // Função para iniciar envio do pedido
            window.iniciarEnvioPedido = function() {
                console.log('[Pedidos] Iniciando envio do pedido...');
                fecharModal();
                document.getElementById('modalLoading').style.display = 'flex';
                
                // Debug: verificar se o formulário existe
                const form = document.getElementById('formPedido');
                console.log('[Pedidos] Formulário encontrado:', form);
                console.log('[Pedidos] Action do formulário:', form.action);
                
                setTimeout(() => {
                    console.log('[Pedidos] Enviando formulário...');
                    form.submit();
                }, 500);
            }
            
            console.log('Função adicionarItem definida inline:', typeof adicionarItem);
            console.log('Função confirmarPedido definida inline:', typeof window.confirmarPedido);
        </script>
        
        
        <hr class="mt-4">

        <div class="text-end">
            <button type="button" class="btn btn-primary btn-lg" data-action="submit-pedido"><i class="bi bi-save icon-text"></i> Salvar Pedido</button>
        </div>
    </form>
</div>

<!-- Modal de Confirmação -->
<div id="modalConfirmacao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1050;">
    <div class="card" style="max-width: 500px; width: 90%;">
        <h4 class="card-header">Confirmar Pedido</h4>
        <div class="card-body">
            <div id="resumoPedido" class="mb-3"></div>
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" data-action="cancel-confirmation"><i class="bi bi-x-circle-fill text-danger icon-text"></i> Cancelar</button>
                <button type="button" class="btn btn-success" data-action="confirm-submit"><i class="bi bi-check icon-text"></i> Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Carregamento -->
<div id="modalLoading" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); align-items: center; justify-content: center; z-index: 2000;">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 fw-bold">SALVANDO PEDIDO</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ nonce }}">
    document.addEventListener('DOMContentLoaded', () => {
        try {
            const itemsContainer = document.getElementById('itens');
            const addItemButton = document.querySelector('[data-action="add-item"]');
            const submitButton = document.querySelector('[data-action="submit-pedido"]');
            const cancelConfirmationButton = document.querySelector('[data-action="cancel-confirmation"]');
            const confirmSubmitButton = document.querySelector('[data-action="confirm-submit"]');
            const formPedido = document.getElementById('formPedido');

            if (addItemButton && typeof adicionarItem === 'function') {
                addItemButton.addEventListener('click', adicionarItem);
            }

            itemsContainer?.addEventListener('click', (event) => {
                const removeButton = event.target.closest('[data-action="remove-item"]');
                if (removeButton) {
                    removeButton.closest('[data-item-index], [data-item-row]')?.remove();
                }
            });

            if (submitButton && typeof window.confirmarPedido === 'function') {
                submitButton.addEventListener('click', window.confirmarPedido);
            }

            if (cancelConfirmationButton && typeof window.fecharModal === 'function') {
                cancelConfirmationButton.addEventListener('click', window.fecharModal);
            }

            if (confirmSubmitButton && typeof window.iniciarEnvioPedido === 'function') {
                confirmSubmitButton.addEventListener('click', window.iniciarEnvioPedido);
            }

            if (formPedido) {
                const selector = '#itens select[name=\"produto_id\"], #itens input[name=\"quantidade\"], #itens input[name=\"preco_venda\"]';

                const avancarOuAdicionar = () => {
                    const campos = Array.from(formPedido.querySelectorAll(selector));
                    const ativo = document.activeElement;
                    const indiceAtual = campos.indexOf(ativo);
                    if (indiceAtual > -1 && indiceAtual < campos.length - 1) {
                        campos[indiceAtual + 1].focus();
                        return;
                    }
                    if (typeof adicionarItem === 'function') {
                        adicionarItem();
                        setTimeout(() => {
                            const novoUltimo = formPedido.querySelector('#itens > div:last-child select');
                            novoUltimo?.focus();
                        }, 50);
                    }
                };

                formPedido.addEventListener('keydown', (event) => {
                    const alvo = event.target;
                    if (!alvo.matches(selector)) {
                        return;
                    }

                    if (event.key === 'Enter') {
                        event.preventDefault();
                        avancarOuAdicionar();
                        return;
                    }

                    if (event.key === 'Tab' && !event.shiftKey) {
                        const campos = Array.from(formPedido.querySelectorAll(selector));
                        if (campos.length && campos[campos.length - 1] === alvo) {
                            event.preventDefault();
                            avancarOuAdicionar();
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Erro na inicialização do formulário de pedido:', error);
        }
    });
</script>
{% endblock %}
