{% extends 'base.html' %}

{% block title %}Dashboard Coletas{% endblock %}

{% block page_title %}Dashboard Coletas{% endblock %}

{% block content %}
<div class="card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="bi bi-box-seam icon-text"></i> Operações de Coleta</h2>
    </div>

    {% if pedidos %}
        <div class="table-toolbar mb-3">
            <div class="input-group shadow-sm" style="max-width: 360px;">
                <span class="input-group-text bg-white">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="search" id="filtroColetas" class="form-control" placeholder="Buscar por cliente ou pedido..." />
            </div>
            <small class="text-muted">Clique nos cabeçalhos para ordenar e use a busca para filtrar rapidamente.</small>
        </div>
        <div class="table-container">
            <table class="coletas-table data-table auto-fit-table">
                <colgroup>
                    <col class="col-cliente">
                    <col class="col-pedidos">
                    <col class="col-data">
                    <col class="col-acoes">
                </colgroup>
                <thead>
                    <tr>
                        <th data-column-index="0" class="text-center">Cliente</th>
                        <th data-column-index="1" class="text-center">Pedidos</th>
                        <th data-column-index="2" class="text-center">Data da última coleta</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in pedidos %}
                        <tr class="coleta-row" data-details-id="">
                            <td>{{ item.cliente_nome }}</td>
                            <td>
                                <div class="d-flex flex-wrap gap-1 justify-content-center">
                                    {% for pedido_id in item.pedidos_ids %}
                                        <span class="badge bg-light text-dark">#{{ pedido_id }}</span>
                                    {% endfor %}
                                </div>
                            </td>
                            <td>
                                {% set data_ref = item.data_mais_recente or (item.pedido.data if item.pedido and item.pedido.data else None) %}
                                {{ data_ref.strftime('%d/%m/%Y') if data_ref else '-' }}
                            </td>
                            <td>
                                {% set processar_base = url_for('coletas.processar_coleta', pedido_id=0).rsplit('/', 1)[0] %}
                                {% set historico_base = url_for('coletas.historico_coletas', pedido_id=0).rsplit('/', 1)[0] %}
                                <div class="action-buttons"
                                     data-processar-base="{{ processar_base }}"
                                     data-historico-base="{{ historico_base }}">
                                    <div class="d-flex flex-column gap-2 align-items-center w-100">
                                        {% if not item.coletado_completo %}
                                        <button type="button"
                                                class="btn btn-sm btn-primary btn-acao-coleta"
                                                data-pedidos="{{ item.pedidos_ids | join(',') }}"
                                                data-cliente="{{ item.cliente_nome }}">
                                            <i class="bi bi-box-seam"></i> COLETAR PEDIDOS
                                        </button>
                                        {% endif %}
                                        {% if item.itens_coletados > 0 %}
                                        <button type="button"
                                                class="btn btn-sm btn-outline-success btn-acao-historico"
                                                data-pedidos="{{ item.pedidos_ids | join(',') }}"
                                                data-cliente="{{ item.cliente_nome }}">
                                            <i class="bi bi-clock-history"></i> HISTÓRICO
                                        </button>
                                        {% endif %}
                                        <button type="button"
                                                class="btn btn-sm btn-dark btn-quant-pendente"
                                                data-pedidos="{{ item.pedidos_ids | join(',') }}"
                                                data-cliente="{{ item.cliente_nome }}">
                                            <i class="bi bi-exclamation-circle"></i> QUANT. PENDENTE
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">
                {% if filtro == 'coletados' %}
                    Nenhum pedido coletado encontrado
                {% elif filtro == 'pendentes' %}
                    Nenhum pedido pendente de coleta
                {% else %}
                    Nenhum pedido encontrado
                {% endif %}
            </h4>
            <p class="text-muted">
                {% if filtro == 'pendentes' %}
                    Todos os pedidos já foram coletados ou não há pedidos com pagamento aprovado.
                {% else %}
                    Não há dados para exibir com o filtro selecionado.
                {% endif %}
            </p>
        </div>
    {% endif %}
</div>

<div class="modal fade" id="modalPendencias" tabindex="-1" aria-labelledby="modalPendenciasLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPendenciasLabel">Pendências de Produtos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted" id="modalPendenciasCliente"></p>
                <div id="pendenciasFeedback" class="alert alert-info d-none"></div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th class="text-center">Quantidade pendente</th>
                            </tr>
                        </thead>
                        <tbody id="pendenciasBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalSelecionarPedido" tabindex="-1" aria-labelledby="modalSelecionarTitulo" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSelecionarTitulo">Selecionar pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-1" id="modalSelecionarCliente"></p>
                <p class="text-muted small" id="modalSelecionarDescricao"></p>
                <div class="mb-3">
                    <label for="modalSelecionarLista" class="form-label">Pedidos liberados</label>
                    <select id="modalSelecionarLista" class="form-select"></select>
                </div>
                <div class="alert alert-warning d-none" id="modalSelecionarFeedback"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="modalSelecionarConfirmar">Continuar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block styles %}
<style>
    .table-toolbar {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 12px;
    }

    .coletas-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: #fff;
        border: 1px solid #d7e3f7;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
        overflow: hidden;
        table-layout: auto;
    }

    .coletas-table th,
    .coletas-table td {
        padding: 12px 14px;
        border: 1px solid #d7e3f7;
        text-align: center;
        font-size: 0.92rem;
        color: #1f2937;
        font-weight: 500;
    }

    .coletas-table th:first-child,
    .coletas-table td:first-child {
        border-left-width: 2px;
    }

    .coletas-table th:last-child,
    .coletas-table td:last-child {
        border-right-width: 2px;
    }

    .coletas-table tbody tr:first-child td {
        border-top-width: 2px;
    }

    .coletas-table tbody tr:last-child td {
        border-bottom-width: 2px;
    }

    .coletas-table thead th {
        background: #f8fafc;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #475569;
        font-weight: 700;
    }

    .coletas-table thead th .sort-indicator {
        font-size: 0.7rem;
        margin-left: 6px;
        color: #94a3b8;
    }

    .coletas-table th[data-column-index] {
        cursor: pointer !important;
        user-select: none;
        position: relative;
    }

    .coletas-table th.sorted-asc,
    .coletas-table th.sorted-desc {
        color: #0d6efd;
    }

    .coletas-table tbody tr:nth-child(even) td {
        background: #fdfefe;
    }

    .coletas-table tbody tr:hover td {
        background: #edf5ff;
    }

    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
    }

    .action-buttons .btn {
        border-radius: 8px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
    }

    .coletas-table .col-cliente { width: 28%; }
    .coletas-table .col-pedidos { width: 22%; }
    .coletas-table .col-data { width: 18%; }
    .coletas-table .col-acoes { width: 32%; }

    .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
    }

    .resizable-header {
        position: relative;
        padding-right: 14px;
        user-select: none;
    }

    .column-resizer {
        position: absolute;
        top: 0;
        right: 2px;
        width: 6px;
        height: 100%;
        cursor: col-resize;
        user-select: none;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script nonce="{{ nonce }}">
document.addEventListener('DOMContentLoaded', () => {
    const tabela = document.querySelector('.coletas-table');
    if (!tabela) return;

    const tbody = tabela.querySelector('tbody');
    const headers = tabela.querySelectorAll('th[data-column-index]');
    const columns = tabela.querySelectorAll('colgroup col');
    const filtro = document.getElementById('filtroColetas');
    const pendenciasModalEl = document.getElementById('modalPendencias');
    const pendenciasBody = document.getElementById('pendenciasBody');
    const pendenciasFeedback = document.getElementById('pendenciasFeedback');
    const pendenciasCliente = document.getElementById('modalPendenciasCliente');
    const selecaoModalEl = document.getElementById('modalSelecionarPedido');
    const selecaoTitulo = document.getElementById('modalSelecionarTitulo');
    const selecaoCliente = document.getElementById('modalSelecionarCliente');
    const selecaoDescricao = document.getElementById('modalSelecionarDescricao');
    const selecaoLista = document.getElementById('modalSelecionarLista');
    const selecaoFeedback = document.getElementById('modalSelecionarFeedback');
    const selecaoConfirmar = document.getElementById('modalSelecionarConfirmar');
    const bootstrapLib = (typeof window !== 'undefined' && window.bootstrap)
        ? window.bootstrap
        : (typeof bootstrap !== 'undefined' ? bootstrap : null);
    const pendenciasModal = pendenciasModalEl && bootstrapLib ? new bootstrapLib.Modal(pendenciasModalEl) : null;
    const selecaoModal = selecaoModalEl && bootstrapLib ? new bootstrapLib.Modal(selecaoModalEl) : null;
    const pendenciasEndpoint = "{{ url_for('coletas.pendencias_itens') }}";
    let currentSort = { index: null, direction: 'asc' };
    let selecaoBaseUrl = null;

    const parsePedidoIds = (valor) => {
        if (!valor) return [];
        return valor
            .split(',')
            .map((parte) => parseInt(parte.trim(), 10))
            .filter((id) => Number.isInteger(id));
    };

    const abrirSelecaoPedidos = ({ tipo, cliente, pedidos, baseUrl }) => {
        if (!Array.isArray(pedidos) || pedidos.length === 0 || !baseUrl) {
            return;
        }

        const destino = (pedidoId) => `${baseUrl}/${pedidoId}`;
        if (pedidos.length === 1) {
            window.location.href = destino(pedidos[0]);
            return;
        }

        if (selecaoTitulo) {
            selecaoTitulo.textContent = tipo === 'historico'
                ? 'Histórico dos pedidos'
                : 'Processar coleta';
        }
        if (selecaoCliente) {
            selecaoCliente.textContent = cliente ? `Cliente: ${cliente}` : '';
        }
        if (selecaoDescricao) {
            selecaoDescricao.textContent = tipo === 'historico'
                ? 'Selecione qual pedido deseja consultar.'
                : 'Selecione qual pedido deseja coletar primeiro.';
        }
        if (selecaoLista) {
            selecaoLista.innerHTML = '';
            pedidos.forEach((pedidoId) => {
                const option = document.createElement('option');
                option.value = pedidoId;
                option.textContent = `Pedido #${pedidoId}`;
                selecaoLista.appendChild(option);
            });
        }
        if (selecaoFeedback) {
            selecaoFeedback.classList.add('d-none');
            selecaoFeedback.textContent = '';
        }
        if (selecaoConfirmar) {
            selecaoConfirmar.textContent = tipo === 'historico'
                ? 'Ver histórico'
                : 'Processar coleta';
        }
        selecaoBaseUrl = baseUrl;

        if (selecaoModal) {
            selecaoModal.show();
        } else if (selecaoModalEl) {
            selecaoModalEl.classList.add('show');
            selecaoModalEl.style.display = 'block';
            selecaoModalEl.removeAttribute('aria-hidden');
        }
    };

    if (selecaoConfirmar) {
        selecaoConfirmar.addEventListener('click', () => {
            if (!selecaoLista || !selecaoBaseUrl) {
                return;
            }
            const pedidoId = parseInt(selecaoLista.value, 10);
            if (!Number.isInteger(pedidoId)) {
                if (selecaoFeedback) {
                    selecaoFeedback.textContent = 'Selecione um pedido válido para continuar.';
                    selecaoFeedback.classList.remove('d-none');
                }
                return;
            }
            window.location.href = `${selecaoBaseUrl}/${pedidoId}`;
        });
    }

    const parseValue = (cell, index) => {
        const text = cell.textContent.trim();
        if (index === 2) {
            if (!text.includes('/')) return text.toLowerCase();
            const [dia, mes, ano] = text.split('/');
            if (!dia || !mes || !ano) return text.toLowerCase();
            return `${ano}-${mes}-${dia}`;
        }
        return text.toLowerCase();
    };

    const applySortIndicators = () => {
        headers.forEach((header) => {
            header.classList.remove('sorted-asc', 'sorted-desc');
            let indicator = header.querySelector('.sort-indicator');
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.className = 'sort-indicator';
                header.appendChild(indicator);
            }
            indicator.innerHTML = '';
        });
        const target = headers[currentSort.index];
        if (!target) return;
        let indicator = target.querySelector('.sort-indicator');
        if (!indicator) {
            indicator = document.createElement('span');
            indicator.className = 'sort-indicator';
            target.appendChild(indicator);
        }
        target.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
        indicator.innerHTML = currentSort.direction === 'asc'
            ? '<i class="bi bi-caret-up-fill"></i>'
            : '<i class="bi bi-caret-down-fill"></i>';
    };

    const sortRows = (index, direction) => {
        const rows = Array.from(tbody.querySelectorAll('tr.coleta-row'));
        rows.sort((rowA, rowB) => {
            const a = parseValue(rowA.children[index], index);
            const b = parseValue(rowB.children[index], index);

            if (typeof a === 'number' && typeof b === 'number') {
                return direction === 'asc' ? a - b : b - a;
            }
            return direction === 'asc'
                ? String(a).localeCompare(String(b))
                : String(b).localeCompare(String(a));
        });

        rows.forEach((row) => tbody.appendChild(row));
        applySortIndicators();
    };

    const applyColumnWidth = (columnIndex, width) => {
        const headerCell = tabela.querySelectorAll('thead th')[columnIndex];
        if (columns.length && columns[columnIndex]) {
            columns[columnIndex].style.width = width + 'px';
        }
        if (headerCell) headerCell.style.width = width + 'px';
        tabela.querySelectorAll('tbody tr').forEach((row) => {
            const cell = row.children[columnIndex];
            if (cell) cell.style.width = width + 'px';
        });
    };

    const autoFitColumn = (columnIndex) => {
        let maxWidth = 0;
        tabela.querySelectorAll('tr').forEach((row) => {
            const cell = row.children[columnIndex];
            if (!cell) return;
            const cellWidth = cell.scrollWidth + 16;
            if (cellWidth > maxWidth) {
                maxWidth = cellWidth;
            }
        });
        applyColumnWidth(columnIndex, Math.max(80, maxWidth));
    };

    const startManualResize = (event, columnIndex) => {
        event.preventDefault();
        const startX = event.pageX;
        const header = event.target.parentElement;
        const startWidth = header.offsetWidth;

        const onMouseMove = (moveEvent) => {
            const delta = moveEvent.pageX - startX;
            const newWidth = Math.max(80, startWidth + delta);
            applyColumnWidth(columnIndex, newWidth);
        };

        const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    };

    headers.forEach((header, index) => {
        header.classList.add('resizable-header');
        let handle = header.querySelector('.column-resizer');
        if (!handle) {
            handle = document.createElement('span');
            handle.className = 'column-resizer';
            header.appendChild(handle);
        }

        handle.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            startManualResize(e, index);
        });

        header.addEventListener('dblclick', (e) => {
            e.stopPropagation();
            autoFitColumn(index);
        });

        header.addEventListener('click', (e) => {
            if (e.target.classList.contains('column-resizer')) {
                return;
            }
            const direction = (currentSort.index === index && currentSort.direction === 'asc') ? 'desc' : 'asc';
            currentSort = { index, direction };
            sortRows(index, direction);
        });
    });

    if (filtro) {
        filtro.addEventListener('input', (event) => {
            const termo = event.target.value.trim().toLowerCase();
            tbody.querySelectorAll('tr.coleta-row').forEach((row) => {
                const texto = row.textContent.toLowerCase();
                row.style.display = texto.includes(termo) ? '' : 'none';
            });
        });
    }

    const setPendenciasFeedback = (message = '', type = 'info') => {
        if (!pendenciasFeedback) return;
        pendenciasFeedback.classList.remove('alert-info', 'alert-warning', 'alert-danger', 'alert-success');
        if (!message) {
            pendenciasFeedback.classList.add('d-none');
            pendenciasFeedback.textContent = '';
            return;
        }
        pendenciasFeedback.textContent = message;
        pendenciasFeedback.classList.remove('d-none');
        pendenciasFeedback.classList.add(`alert-${type}`);
    };

    const renderPendencias = (itens) => {
        if (!pendenciasBody) {
            return;
        }
        pendenciasBody.innerHTML = '';
        if (!Array.isArray(itens) || itens.length === 0) {
            setPendenciasFeedback('Nenhum item pendente encontrado.', 'info');
            return;
        }
        setPendenciasFeedback('');
        itens.forEach((item) => {
            const row = document.createElement('tr');
            const produtoCell = document.createElement('td');
            produtoCell.textContent = item.produto;
            const quantidadeCell = document.createElement('td');
            quantidadeCell.className = 'text-center fw-bold';
            quantidadeCell.textContent = item.quantidade;
            row.appendChild(produtoCell);
            row.appendChild(quantidadeCell);
            pendenciasBody.appendChild(row);
        });
    };

    tabela.addEventListener('click', async (event) => {
        const coletaBtn = event.target.closest('.btn-acao-coleta');
        if (coletaBtn) {
            const container = coletaBtn.closest('.action-buttons');
            const baseUrl = container ? container.dataset.processarBase : null;
            const pedidos = parsePedidoIds(coletaBtn.dataset.pedidos);
            abrirSelecaoPedidos({
                tipo: 'coleta',
                cliente: coletaBtn.dataset.cliente || '',
                pedidos,
                baseUrl,
            });
            return;
        }

        const historicoBtn = event.target.closest('.btn-acao-historico');
        if (historicoBtn) {
            const container = historicoBtn.closest('.action-buttons');
            const baseUrl = container ? container.dataset.historicoBase : null;
            const pedidos = parsePedidoIds(historicoBtn.dataset.pedidos);
            abrirSelecaoPedidos({
                tipo: 'historico',
                cliente: historicoBtn.dataset.cliente || '',
                pedidos,
                baseUrl,
            });
            return;
        }

        const button = event.target.closest('.btn-quant-pendente');
        if (!button) {
            return;
        }

        const pedidoIds = [...new Set(parsePedidoIds(button.dataset.pedidos))];
        if (!pedidoIds.length) {
            return;
        }

        if (pendenciasCliente) {
            pendenciasCliente.textContent = `Cliente: ${button.dataset.cliente || 'N/A'}`;
        }
        setPendenciasFeedback('Carregando itens pendentes...', 'info');
        renderPendencias([]);

        try {
                const response = await fetch(pendenciasEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.CSRF_TOKEN,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ pedido_ids: pedidoIds })
                });

            const result = await response.json();
            if (!response.ok || !result.success) {
                throw new Error(result.error || 'Não foi possível carregar as pendências.');
            }

            renderPendencias(result.pendencias || []);
        } catch (error) {
            setPendenciasFeedback(error.message, 'danger');
            if (pendenciasBody) {
                pendenciasBody.innerHTML = '';
            }
        }

        if (pendenciasModal) {
            pendenciasModal.show();
        } else if (pendenciasModalEl) {
            pendenciasModalEl.classList.add('show');
            pendenciasModalEl.style.display = 'block';
            pendenciasModalEl.removeAttribute('aria-hidden');
        }
    });
});
</script>
{% endblock %}
