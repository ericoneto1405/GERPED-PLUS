{% extends 'base.html' %}

{% block title %}Financeiro{% endblock %}

{% block page_title %}Financeiro{% endblock %}

{% block content %}
<div class="card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="bi bi-bar-chart icon-text"></i> Painel Financeiro</h2>
        <div class="d-flex gap-2">
            <a href="{{ url_for('financeiro.exportar_financeiro', filtro=filtro, mes=mes, ano=ano) }}" class="btn btn-success"><i class="bi bi-download icon-text"></i> Exportar Excel</a>
        </div>
    </div>

    <!-- Filtro de Mês e Ano -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title"><i class="bi bi-calendar-event icon-text"></i> Filtro por Período</h5>
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="mes" class="form-label">Mês:</label>
                    <select name="mes" id="mes" class="form-select">
                        <option value="">Todos os meses</option>
                        <option value="1" {% if mes == '1' %}selected{% endif %}>Janeiro</option>
                        <option value="2" {% if mes == '2' %}selected{% endif %}>Fevereiro</option>
                        <option value="3" {% if mes == '3' %}selected{% endif %}>Março</option>
                        <option value="4" {% if mes == '4' %}selected{% endif %}>Abril</option>
                        <option value="5" {% if mes == '5' %}selected{% endif %}>Maio</option>
                        <option value="6" {% if mes == '6' %}selected{% endif %}>Junho</option>
                        <option value="7" {% if mes == '7' %}selected{% endif %}>Julho</option>
                        <option value="8" {% if mes == '8' %}selected{% endif %}>Agosto</option>
                        <option value="9" {% if mes == '9' %}selected{% endif %}>Setembro</option>
                        <option value="10" {% if mes == '10' %}selected{% endif %}>Outubro</option>
                        <option value="11" {% if mes == '11' %}selected{% endif %}>Novembro</option>
                        <option value="12" {% if mes == '12' %}selected{% endif %}>Dezembro</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="ano" class="form-label">Ano:</label>
                    <select name="ano" id="ano" class="form-select">
                        <option value="">Todos os anos</option>
                        <option value="2023" {% if ano == '2023' %}selected{% endif %}>2023</option>
                        <option value="2024" {% if ano == '2024' %}selected{% endif %}>2024</option>
                        <option value="2025" {% if ano == '2025' %}selected{% endif %}>2025</option>
                        <option value="2026" {% if ano == '2026' %}selected{% endif %}>2026</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtro" class="form-label">Status:</label>
                    <select name="filtro" id="filtro" class="form-select">
                        <option value="todos" {% if filtro == 'todos' %}selected{% endif %}>Todos</option>
                        <option value="pendentes" {% if filtro == 'pendentes' %}selected{% endif %}>Pendentes</option>
                        <option value="pagos" {% if filtro == 'pagos' %}selected{% endif %}>Pagos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search icon-text"></i> Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="table-toolbar mb-3">
        <div class="input-group shadow-sm" style="max-width: 360px;">
            <span class="input-group-text bg-white">
                <i class="fas fa-search text-muted"></i>
            </span>
            <input type="search" id="filtroFinanceiro" class="form-control" placeholder="Buscar por cliente, status, valor..." />
        </div>
        <small class="text-muted">Clique nos cabeçalhos para ordenar e utilize a busca para filtrar rapidamente.</small>
    </div>

    <div class="table-container">
        <table class="financeiro-table">
            <thead>
                <tr>
                    <th data-column-index="0">#</th>
                    <th data-column-index="1">CLIENTE</th>
                    <th data-column-index="2">DATA E HORA</th>
                    <th data-column-index="3">STATUS</th>
                    <th data-column-index="4">VALOR DO PEDIDO</th>
                    <th data-column-index="5">TOTAL PAGO</th>
                    <th data-column-index="6">SALDO</th>
                    <th>AÇÕES</th>
                </tr>
            </thead>
            <tbody>
                {% for item in pedidos %}
                {% set pedido = item.pedido %}
                {% set total = item.total_pedido %}
                {% set pago = item.total_pago %}
                <tr class="align-middle pedido-row" data-details-id="details-{{ pedido.id }}">
                    <td>#{{ pedido.id }}</td>
                    <td>{{ pedido.cliente.nome }}</td>
                    <td>{{ pedido.data.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td class="{% if item.status == 'PAGO' %}status-financeiro{% elif item.status == 'PAGO PARCIAL' %}status-coleta{% elif item.status == 'AGUARDANDO' %}status-pendente{% else %}status-secundario{% endif %}">
                        {{ item.status }}
                    </td>
                    <td>{{ total | currency_brl }}</td>
                    <td>{{ pago | currency_brl }}</td>
                    <td>{{ (total - pago if total - pago > 0 else 0) | currency_brl }}</td>
                    <td>
                        <div class="financeiro-actions">
                            <a href="{{ url_for('pedidos.visualizar_pedido', id=pedido.id, origem='financeiro') }}" class="btn btn-sm btn-warning" target="_blank" title="Visualizar Pedido"><i class="bi bi-eye icon-text"></i></a>
                            <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#details-{{ pedido.id }}" aria-expanded="false" aria-controls="details-{{ pedido.id }}" title="Detalhes dos Pagamentos"><i class="bi bi-journal-text icon-text"></i></button>
                            {% if item.status in ['AGUARDANDO', 'PAGO PARCIAL'] %}
                                <a href="{{ url_for('financeiro.registrar_pagamento', pedido_id=pedido.id) }}" class="btn btn-primary btn-registrar" title="Registrar Pagamento"><i class="bi bi-credit-card icon-text"></i> Registrar</a>
                            {% endif %}
                            <a href="{{ url_for('financeiro.editar_pagamento', pedido_id=pedido.id) }}"
                               class="btn btn-sm btn-primary"
                               title="Editar Pagamento"
                               data-action="open-edit-payment"
                               target="_blank"
                               rel="noopener"><i class="bi bi-pencil icon-text"></i></a>
                            {% if pago == 0 or pago == 0.0 %}
                                <button class="btn btn-sm btn-secondary" 
                                        data-action="retornar-comercial"
                                        data-pedido-id="{{ pedido.id }}"
                                        title="Retornar para Comercial (Pedido sem pagamentos)"><i class="bi bi-arrow-left icon-text"></i></button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                <tr class="collapse" id="details-{{ pedido.id }}">
                    <td colspan="8">
                        <div class="p-3 bg-light">
                            <h5>Histórico de Pagamentos do Pedido #{{ pedido.id }}</h5>
                            {% if pedido.pagamentos %}
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Data/Hora</th>
                                            <th>Valor</th>
                                            <th>Método</th>
                                            <th>ID Transação</th>
                                            <th>Comprovante</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% for pagamento in pedido.pagamentos %}
                                        <tr>
                                            <td>{{ pagamento.data_pagamento.strftime('%d/%m/%Y %H:%M') }}</td>
                                            <td><strong>{{ pagamento.valor | currency_brl }}</strong></td>
                                            <td><em>{{ pagamento.metodo_pagamento }}</em></td>
                                            <td>
                                                {% if pagamento.id_transacao %}
                                                    <span class="badge bg-dark">{{ pagamento.id_transacao }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% set principal = pagamento.anexo_principal %}
                                                {% if principal %}
                                                    <a href="{{ url_for('financeiro.ver_recibo', filename=principal.caminho) }}" class="btn btn-sm btn-outline-primary" target="_blank" title="Ver comprovante principal"><i class="bi bi-file-earmark-text icon-text"></i></a>
                                                {% elif pagamento.caminho_recibo %}
                                                    <a href="{{ url_for('financeiro.ver_recibo', filename=pagamento.caminho_recibo) }}" class="btn btn-sm btn-outline-primary" target="_blank" title="Ver comprovante"><i class="bi bi-file-earmark-text icon-text"></i></a>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                                {% if pagamento.anexos_extra %}
                                                    <div class="mt-1" style="display:flex; flex-direction:column; gap:2px;">
                                                        {% for anexo in pagamento.anexos_extra %}
                                                            <a href="{{ url_for('financeiro.ver_recibo', filename=anexo.caminho) }}" class="btn btn-sm btn-outline-secondary" target="_blank">Anexo extra {{ loop.index }}</a>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                <p>Nenhum pagamento registrado para este pedido.</p>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center">Nenhum pedido encontrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style nonce="{{ nonce }}">
    .table-container {
        width: 100%;
        overflow-x: auto;
        margin-top: 15px;
    }

    .table-toolbar {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .financeiro-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        border-radius: 12px;
        overflow: hidden;
    }

    .financeiro-table thead th,
    .financeiro-table tbody td {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f4;
        text-align: center;
    }

    .financeiro-table thead th {
        background: #f8f9fa;
        font-weight: 600;
    }

    .financeiro-table thead th[data-column-index] {
        cursor: pointer;
        user-select: none;
        position: relative;
    }

    .financeiro-table thead th[data-column-index] .sort-indicator {
        font-size: 0.7rem;
        margin-left: 6px;
        color: #adb5bd;
    }

    .financeiro-table thead th.sorted-asc,
    .financeiro-table thead th.sorted-desc {
        color: #0d6efd;
    }

    .status-financeiro {
        color: #28a745;
        background-color: rgba(40, 167, 69, 0.1);
        font-weight: bold;
        padding: 6px 10px;
        border-radius: 4px;
    }

    .status-coleta {
        color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
        font-weight: bold;
        padding: 6px 10px;
        border-radius: 4px;
    }

    .status-pendente {
        color: #b02a37;
        background-color: rgba(220, 53, 69, 0.12);
        font-weight: bold;
        padding: 6px 10px;
        border-radius: 4px;
    }

    .status-secundario {
        color: #41464b;
        background-color: rgba(108, 117, 125, 0.2);
        font-weight: bold;
        padding: 6px 10px;
        border-radius: 4px;
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .bg-dark {
        background-color: #212529 !important;
    }

    .financeiro-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }

    .financeiro-actions .btn {
        min-width: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }

    .financeiro-actions .btn-registrar {
        min-width: 140px;
        background: var(--accent-purple);
        color: #fff;
        font-weight: 600;
        padding: 8px 16px;
        border-radius: 8px;
    }

    .financeiro-actions .btn-registrar:hover {
        background: var(--accent-purple-light);
        color: #fff;
    }

    .spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script nonce="{{ nonce }}">
    document.addEventListener('DOMContentLoaded', function() {
        const tabela = document.querySelector('.financeiro-table');
        if (!tabela) return;

        const tbody = tabela.querySelector('tbody');
        const headers = tabela.querySelectorAll('th[data-column-index]');
        const filtro = document.getElementById('filtroFinanceiro');
        let currentSort = { index: null, direction: 'asc' };

        const parseValue = (cell, index) => {
            const text = cell.textContent.trim();
            if (index === 0) {
                const numero = parseInt(text.replace('#', ''), 10);
                return Number.isNaN(numero) ? text.toLowerCase() : numero;
            }
            if (index === 2) {
                const [data, hora] = text.split(' ');
                if (!data || !hora) return text.toLowerCase();
                const [dia, mes, ano] = data.split('/');
                return `${ano}-${mes}-${dia} ${hora}`;
            }
            if ([4, 5, 6].includes(index)) {
                const normalizado = text.replace(/R\$\s*/i, '').replace(/\./g, '').replace(',', '.');
                const valor = parseFloat(normalizado);
                return Number.isNaN(valor) ? 0 : valor;
            }
            return text.toLowerCase();
        };

        const getRowPairs = () => {
            const rows = [];
            tbody.querySelectorAll('tr.pedido-row').forEach((row) => {
                const detailsId = row.getAttribute('data-details-id');
                const detailRow = detailsId ? document.getElementById(detailsId) : null;
                rows.push({ row, detail: detailRow });
            });
            return rows;
        };

        const applySortIndicators = () => {
            headers.forEach((header) => {
                header.classList.remove('sorted-asc', 'sorted-desc');
                let indicator = header.querySelector('.sort-indicator');
                if (!indicator) {
                    indicator = document.createElement('span');
                    indicator.className = 'sort-indicator';
                    header.appendChild(indicator);
                }
            indicator.innerHTML = '';
            });
            const target = headers[currentSort.index];
            if (!target) return;
            let indicator = target.querySelector('.sort-indicator');
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.className = 'sort-indicator';
                target.appendChild(indicator);
            }
        target.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
        indicator.innerHTML = currentSort.direction === 'asc'
            ? '<i class="bi bi-caret-up-fill"></i>'
            : '<i class="bi bi-caret-down-fill"></i>';
        };

        const sortRows = (index, direction) => {
            const pairs = getRowPairs();
            pairs.sort((a, b) => {
                const valA = parseValue(a.row.children[index], index);
                const valB = parseValue(b.row.children[index], index);

                if (typeof valA === 'number' && typeof valB === 'number') {
                    return direction === 'asc' ? valA - valB : valB - valA;
                }
                return direction === 'asc'
                    ? String(valA).localeCompare(String(valB))
                    : String(valB).localeCompare(String(valA));
            });

            pairs.forEach(({ row, detail }) => {
                tbody.appendChild(row);
                if (detail) {
                    tbody.appendChild(detail);
                }
            });
            applySortIndicators();
        };

        headers.forEach((header, index) => {
            header.addEventListener('click', () => {
                const direction = (currentSort.index === index && currentSort.direction === 'asc') ? 'desc' : 'asc';
                currentSort = { index, direction };
                sortRows(index, direction);
            });
        });
        applySortIndicators();

        if (filtro) {
            filtro.addEventListener('input', (event) => {
                const termo = event.target.value.trim().toLowerCase();
                getRowPairs().forEach(({ row, detail }) => {
                    const texto = row.textContent.toLowerCase() + (detail ? detail.textContent.toLowerCase() : '');
                    const match = texto.includes(termo);
                    row.style.display = match ? '' : 'none';
                    if (detail) {
                        detail.style.display = match ? '' : 'none';
                    }
                });
            });
        }

        document.querySelectorAll('[data-action="open-edit-payment"]').forEach((link) => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                window.open(link.href, '_blank', 'noopener');
            });
        });

        const botoesRetornar = document.querySelectorAll('[data-action="retornar-comercial"]');
        botoesRetornar.forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const pedidoId = this.getAttribute('data-pedido-id');
                
                if (confirm('Tem certeza que deseja retornar este pedido para o comercial? Esta ação só é permitida para pedidos sem pagamentos.')) {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || window.CSRF_TOKEN;
                    
                    fetch(`/financeiro/retornar-comercial/${pedidoId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => {
                        console.log('Resposta recebida:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Dados:', data);
                        if (data.success) {
                            alert(data.message);
                            window.location.reload();
                        } else {
                            alert('Erro: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Erro na requisição:', error);
                        alert('Erro ao processar requisição: ' + error);
                    });
                } else {
                    console.log('Ação cancelada pelo usuário');
                }
            });
        });
    });
</script>
{% endblock %}
