{% extends "base.html" %}

{% block title %}Log de Atividades{% endblock %}
{% block page_title %}Log de Atividades{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="d-flex flex-column flex-lg-row justify-content-between gap-3">
        <div>
            <h2 class="mb-1"><i class="bi bi-journal-text icon-text"></i> Auditoria do Sistema</h2>
            <p class="text-muted mb-0">Histórico completo das ações realizadas por cada usuário.</p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-action="limpar-filtros">
                <i class="bi bi-arrow-repeat icon-text"></i> Limpar filtros
            </button>
            <button type="button" class="btn btn-success btn-sm" data-action="exportar-logs">
                <i class="bi bi-download icon-text"></i> Exportar CSV
            </button>
        </div>
    </div>

    <form method="get" class="row g-3 align-items-end mt-3">
        <div class="col-md-3">
            <label for="busca" class="form-label">Buscar palavras-chave</label>
            <input type="text" id="busca" name="busca" class="form-control"
                   placeholder="Título ou descrição"
                   value="{{ filtros.get('busca', '') }}">
        </div>
        <div class="col-md-2">
            <label for="mes_ano" class="form-label">Período (mês/ano)</label>
            <input type="month" id="mes_ano" name="mes_ano" class="form-control"
                   value="{{ filtros.get('mes_ano', '') }}">
        </div>
        <div class="col-md-2">
            <label for="usuario_id" class="form-label">Usuário</label>
            <select id="usuario_id" name="usuario_id" class="form-select">
                <option value="">Todos</option>
                {% for usuario in usuarios %}
                    <option value="{{ usuario.id }}" {% if filtros.get('usuario_id') == usuario.id %}selected{% endif %}>
                        {{ usuario.nome }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="modulo" class="form-label">Módulo</label>
            <select id="modulo" name="modulo" class="form-select">
                <option value="">Todos</option>
                {% for modulo in modulos %}
                    <option value="{{ modulo }}" {% if filtros.get('modulo') == modulo %}selected{% endif %}>
                        {{ modulo }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="tipo" class="form-label">Tipo</label>
            <select id="tipo" name="tipo" class="form-select">
                <option value="">Todos</option>
                <option value="criação" {% if filtros.get('tipo') == 'criação' %}selected{% endif %}>Criação</option>
                <option value="edição" {% if filtros.get('tipo') == 'edição' %}selected{% endif %}>Edição</option>
                <option value="exclusão" {% if filtros.get('tipo') == 'exclusão' %}selected{% endif %}>Exclusão</option>
                <option value="login" {% if filtros.get('tipo') == 'login' %}selected{% endif %}>Login/Acesso</option>
            </select>
        </div>
        <div class="col-md-1">
            <label for="per_page" class="form-label">Por página</label>
            <select id="per_page" name="per_page" class="form-select">
                {% for size in [20, 50, 100, 200] %}
                    <option value="{{ size }}" {% if per_page == size %}selected{% endif %}>{{ size }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-auto">
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-search icon-text"></i> Aplicar
            </button>
        </div>
    </form>
</div>

<div class="row g-3 mb-4">
    <div class="col-sm-6 col-lg-3">
        <div class="mini-stat">
            <span>Total registrado</span>
            <strong>{{ stats.get('total_atividades', 0) }}</strong>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="mini-stat">
            <span>Hoje</span>
            <strong>{{ stats.get('atividades_hoje', 0) }}</strong>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="mini-stat">
            <span>Últimos 7 dias</span>
            <strong>{{ stats.get('atividades_7_dias', 0) }}</strong>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="mini-stat">
            <span>Usuários ativos (30d)</span>
            <strong>{{ stats.get('usuarios_ativos', 0) }}</strong>
        </div>
    </div>
</div>

<div class="card">
    {% if atividades %}
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
            {% set inicio = (page - 1) * per_page + 1 if total_registros > 0 else 0 %}
            {% set fim = [page * per_page, total_registros]|min %}
            <small class="text-muted">
                Exibindo {{ inicio }} - {{ fim }} de {{ total_registros }} registros
            </small>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Data/Hora</th>
                        <th scope="col">Usuário</th>
                        <th scope="col">Título</th>
                        <th scope="col">Módulo</th>
                        <th scope="col">Tipo</th>
                        <th scope="col" class="text-center">Detalhes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for atividade in atividades %}
                        <tr>
                            <td>#{{ atividade.id }}</td>
                            <td>
                                <div class="fw-semibold">
                                    <span class="js-utc" data-utc="{{ atividade.data_hora|datetime_utc_iso }}" data-format="DD/MM/YYYY">
                                        {{ atividade.data_hora.strftime('%d/%m/%Y') }}
                                    </span>
                                </div>
                                <small class="text-muted">
                                    <span class="js-utc" data-utc="{{ atividade.data_hora|datetime_utc_iso }}" data-format="HH:mm:ss">
                                        {{ atividade.data_hora.strftime('%H:%M:%S') }}
                                    </span>
                                </small>
                            </td>
                            <td>{{ atividade.usuario.nome if atividade.usuario else 'Sistema' }}</td>
                            <td>
                                <div class="fw-semibold">{{ atividade.titulo }}</div>
                                <small class="text-muted">{{ atividade.descricao|truncate(90) }}</small>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">
                                    {{ get_modulo_icon(atividade.modulo) }} {{ atividade.modulo }}
                                </span>
                            </td>
                            <td>
                                <span class="badge {{ tipo_badge_class(atividade.tipo_atividade) }}">
                                    {{ atividade.tipo_atividade }}
                                </span>
                            </td>
                            <td class="text-center">
                                <button type="button"
                                        class="btn btn-link btn-sm text-decoration-none"
                                        data-action="toggle-details"
                                        data-target="details-{{ atividade.id }}">
                                    <i class="bi bi-caret-down-fill"></i>
                                </button>
                            </td>
                        </tr>
                        <tr id="details-{{ atividade.id }}" class="activity-details" style="display: none;">
                            <td colspan="7">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <strong>Descrição completa</strong>
                                        <p class="mb-0">{{ atividade.descricao }}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>IP</strong>
                                        <p class="mb-0">{{ atividade.ip_address or 'Não informado' }}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Tipo</strong>
                                        <p class="mb-0">{{ atividade.tipo_atividade }}</p>
                                    </div>
                                    {% if atividade.dados_extras %}
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <strong>Dados adicionais</strong>
                                                <button type="button"
                                                        class="btn btn-outline-secondary btn-sm"
                                                        data-action="copy-extras"
                                                        data-content="{{ atividade.dados_extras|e }}">
                                                    <i class="bi bi-clipboard icon-text"></i> Copiar
                                                </button>
                                            </div>
                                            <pre class="extras-block">{{ atividade.dados_extras }}</pre>
                                        </div>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if total_paginas > 1 %}
            <nav class="mt-3">
                <ul class="pagination pagination-sm">
                    <li class="page-item {% if page == 1 %}disabled{% endif %}">
                        <a class="page-link"
                           href="{{ url_for('log_atividades.listar_atividades',
                                            page=page-1,
                                            per_page=per_page,
                                            mes_ano=filtros.get('mes_ano', ''),
                                            usuario_id=filtros.get('usuario_id', ''),
                                            modulo=filtros.get('modulo', ''),
                                            tipo=filtros.get('tipo', ''),
                                            busca=filtros.get('busca', '')) }}">Anterior</a>
                    </li>
                    {% for p in range(1, total_paginas + 1) %}
                        {% if p == page %}
                            <li class="page-item active">
                                <span class="page-link">{{ p }}</span>
                            </li>
                        {% elif p == 1 or p == total_paginas or (p >= page - 2 and p <= page + 2) %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="{{ url_for('log_atividades.listar_atividades',
                                                    page=p,
                                                    per_page=per_page,
                                                    mes_ano=filtros.get('mes_ano', ''),
                                                    usuario_id=filtros.get('usuario_id', ''),
                                                    modulo=filtros.get('modulo', ''),
                                                    tipo=filtros.get('tipo', ''),
                                                    busca=filtros.get('busca', '')) }}">{{ p }}</a>
                            </li>
                        {% elif p == page - 3 or p == page + 3 %}
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                        {% endif %}
                    {% endfor %}
                    <li class="page-item {% if page == total_paginas %}disabled{% endif %}">
                        <a class="page-link"
                           href="{{ url_for('log_atividades.listar_atividades',
                                            page=page+1,
                                            per_page=per_page,
                                            mes_ano=filtros.get('mes_ano', ''),
                                            usuario_id=filtros.get('usuario_id', ''),
                                            modulo=filtros.get('modulo', ''),
                                            tipo=filtros.get('tipo', ''),
                                            busca=filtros.get('busca', '')) }}">Próxima</a>
                    </li>
                </ul>
            </nav>
        {% endif %}
    {% else %}
        <div class="text-center py-5">
            <div class="mb-3"><i class="bi bi-inboxes fs-1 text-muted"></i></div>
            <h5>Nenhuma atividade encontrada</h5>
            <p class="text-muted mb-3">Ajuste os filtros ou amplie o período para visualizar registros.</p>
            <button type="button" class="btn btn-outline-primary btn-sm" data-action="limpar-filtros">
                Limpar filtros
            </button>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block styles %}
<style nonce="{{ nonce }}">
.mini-stat {
    background: #fff;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.mini-stat span {
    display: block;
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #6c757d;
    letter-spacing: 0.5px;
}

.mini-stat strong {
    font-size: 1.5rem;
    color: #2c3e50;
}

.activity-details {
    background: #f9fafb;
}

.extras-block {
    background: #fff;
    border-radius: 8px;
    padding: 0.75rem;
    max-height: 240px;
    overflow-y: auto;
    font-size: 0.85rem;
}
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script nonce="{{ nonce }}">
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-action="toggle-details"]').forEach((button) => {
        button.addEventListener('click', () => {
            const targetId = button.dataset.target;
            const row = document.getElementById(targetId);
            if (!row) return;
            const isHidden = row.style.display === 'none' || row.style.display === '';
            row.style.display = isHidden ? 'table-row' : 'none';
            button.querySelector('i').classList.toggle('bi-caret-up-fill', isHidden);
            button.querySelector('i').classList.toggle('bi-caret-down-fill', !isHidden);
        });
    });

    document.querySelectorAll('[data-action="copy-extras"]').forEach((button) => {
        button.addEventListener('click', () => {
            const content = button.dataset.content || '';
            navigator.clipboard.writeText(content)
                .then(() => alert('Dados copiados para a área de transferência.'))
                .catch(() => alert('Não foi possível copiar o conteúdo.'));
        });
    });

    document.querySelectorAll('[data-action="limpar-filtros"]').forEach((button) => {
        button.addEventListener('click', () => {
            window.location.href = "{{ url_for('log_atividades.listar_atividades') }}";
        });
    });

    document.querySelectorAll('[data-action="exportar-logs"]').forEach((button) => {
        button.addEventListener('click', () => {
            const params = new URLSearchParams(window.location.search);
            const exportUrl = "{{ url_for('log_atividades.exportar_logs') }}?" + params.toString();

            fetch(exportUrl)
                .then((response) => response.json())
                .then((data) => {
                    if (!data.success) {
                        alert(data.error || 'Erro ao exportar logs.');
                        return;
                    }

                    const rows = ['ID,Usuário,Tipo,Título,Descrição,Módulo,Data'];
                    data.dados.forEach((item) => {
                        const linha = [
                            item.id,
                            `"${item.usuario}"`,
                            `"${item.tipo_atividade}"`,
                            `"${item.titulo}"`,
                            `"${item.descricao}"`,
                            `"${item.modulo}"`,
                            `"${item.data_criacao}"`
                        ].join(',');
                        rows.push(linha);
                    });

                const csvContent = rows.join('\\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `log_atividades_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                })
                .catch(() => alert('Erro ao gerar arquivo para exportação.'));
        });
    });
});
</script>
{% endblock %}

{% macro get_modulo_icon(modulo) -%}
    {% set nome_modulo = modulo or '' %}
    {% if nome_modulo == 'Clientes' %}<i class="bi bi-people icon-text"></i>
    {% elif nome_modulo == 'Produtos' %}<i class="bi bi-box-seam icon-text"></i>
    {% elif nome_modulo == 'Pedidos' %}<i class="bi bi-pencil-square icon-text"></i>
    {% elif nome_modulo == 'Financeiro' %}<i class="bi bi-cash-stack icon-text"></i>
    {% elif nome_modulo == 'Coletas' or nome_modulo == 'Logística' %}<i class="bi bi-truck icon-text"></i>
    {% elif nome_modulo == 'Usuários' %}<i class="bi bi-person icon-text"></i>
    {% elif nome_modulo == 'Estoque' %}<i class="bi bi-bar-chart icon-text"></i>
    {% else %}<i class="bi bi-clipboard icon-text"></i>
    {% endif %}
{%- endmacro %}

{% macro tipo_badge_class(tipo) -%}
    {% set tipo_lower = (tipo or '')|lower %}
    {% if 'exclu' in tipo_lower %}bg-danger
    {% elif 'edi' in tipo_lower or 'atualiz' in tipo_lower %}bg-warning text-dark
    {% elif 'cri' in tipo_lower or 'cad' in tipo_lower %}bg-success
    {% elif 'login' in tipo_lower or 'acesso' in tipo_lower %}bg-info text-dark
    {% else %}bg-secondary
    {% endif %}
{%- endmacro %}
