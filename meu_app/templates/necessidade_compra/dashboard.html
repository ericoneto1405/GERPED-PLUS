{% extends "base.html" %}

{% block title %}An√°lise de Necessidade de Compra - Sistema GERPED{% endblock %}

{% block content %}
<!-- Tabela de An√°lise de Necessidade de Compra -->
<div class="necessidade-compra-section mb-4">
    <div class="section-header">
        <h3>üìä An√°lise de Necessidade de Compra</h3>
        <p style="color: #6c757d; font-size: 0.9rem; margin-top: 5px;">
            Baseado nos pedidos liberados pelo Financeiro
        </p>
    </div>
    
    {% if necessidade_compra %}
    <!-- Resumo Total -->
    {% set total_valor_necessidade = necessidade_compra | sum(attribute='valor_total_necessidade') %}
    {% if total_valor_necessidade > 0 %}
    <div class="alert alert-warning" style="margin-bottom: 20px; padding: 12px 16px; border-left: 4px solid #dc3545;">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; font-size: 0.95rem;">
            <strong>üí∞ Necessidade Total de Compra Valor:</strong>
            <span style="font-weight: 600; color: #dc3545;">
                {{ "R$ {:,.2f}".format(total_valor_necessidade).replace(',', 'X').replace('.', ',').replace('X', '.') }}
            </span>
        </div>
    </div>
    {% endif %}
    
    <div class="table-responsive">
        <table class="necessidade-table">
            <thead>
                <tr>
                    <th>PRODUTO</th>
                    <th>PEDIDOS<br>LIBERADOS</th>
                    <th>ESTOQUE</th>
                    <th>SALDO</th>
                    <th>NECESSIDADE<br>DE COMPRA</th>
                    <th>VALOR<br>UNIT√ÅRIO</th>
                    <th>VALOR<br>TOTAL</th>
                    <th>STATUS</th>
                </tr>
            </thead>
            <tbody>
                {% for item in necessidade_compra %}
                <tr class="{% if item.status == 'CR√çTICO' %}row-critico{% elif item.status == 'ZERADO' %}row-zerado{% else %}row-ok{% endif %}">
                    <td style="text-align: left; font-weight: 600;">{{ item.produto_nome }}</td>
                    <td>{{ item.quantidade_pedida }}</td>
                    <td>{{ item.quantidade_estoque }}</td>
                    <td class="{% if item.saldo < 0 %}text-danger{% elif item.saldo > 0 %}text-success{% else %}text-warning{% endif %}">
                        {{ item.saldo }}
                    </td>
                    <td class="necessidade-cell">
                        {% if item.necessidade_compra > 0 %}
                            <span class="badge-compra">{{ item.necessidade_compra }} cxs.</span>
                        {% else %}
                            <span style="color: #28a745;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td style="text-align: right;">
                        {{ "R$ {:,.2f}".format(item.valor_compra).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                    </td>
                    <td style="text-align: right; font-weight: bold;">
                        {% if item.valor_total_necessidade > 0 %}
                            <span style="color: #dc3545;">
                                {{ "R$ {:,.2f}".format(item.valor_total_necessidade).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                            </span>
                        {% else %}
                            <span style="color: #28a745;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.status == 'CR√çTICO' %}
                            <span class="badge-critico">üö® CR√çTICO</span>
                        {% elif item.status == 'ZERADO' %}
                            <span class="badge-zerado">‚ö†Ô∏è ZERADO</span>
                        {% else %}
                            <span class="badge-ok">‚úÖ SUFICIENTE</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% else %}
    <div style="padding: 30px; text-align: center; background: #f8f9fa; border-radius: 8px;">
        <p style="color: #6c757d; margin: 0;">
            ‚ÑπÔ∏è Nenhum pedido com pagamento aprovado no momento.
        </p>
    </div>
    {% endif %}
</div>

<style>
    .necessidade-compra-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .section-header h3 {
        color: #2c3e50;
        margin: 0 0 5px 0;
        font-size: 1.5rem;
    }
    
    .necessidade-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .necessidade-table thead {
        background: #f8f9fa;
    }
    
    .necessidade-table th {
        padding: 12px 16px;
        text-align: center;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        font-size: 0.9rem;
    }
    
    .necessidade-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f4;
        text-align: center;
        font-size: 0.9rem;
    }
    
    .necessidade-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .row-critico {
        background-color: #fff5f5 !important;
    }
    
    .row-critico:hover {
        background-color: #fed7d7 !important;
    }
    
    .row-zerado {
        background-color: #fffbeb !important;
    }
    
    .row-zerado:hover {
        background-color: #fef3c7 !important;
    }
    
    .row-ok {
        background-color: #f0fff4 !important;
    }
    
    .row-ok:hover {
        background-color: #c6f6d5 !important;
    }
    
    .text-danger {
        color: #dc3545;
        font-weight: bold;
    }
    
    .text-success {
        color: #28a745;
        font-weight: bold;
    }
    
    .text-warning {
        color: #ffc107;
        font-weight: bold;
    }
    
    .badge-compra {
        background-color: #dc3545;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .badge-critico {
        background-color: #dc3545;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .badge-zerado {
        background-color: #ffc107;
        color: #000;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .badge-ok {
        background-color: #28a745;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .necessidade-cell {
        text-align: center;
    }
    
    @media (max-width: 768px) {
        .necessidade-table {
            font-size: 0.8rem;
        }
        
        .necessidade-table th,
        .necessidade-table td {
            padding: 8px 12px;
        }
    }
</style>
{% endblock %}
