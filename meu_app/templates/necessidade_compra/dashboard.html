{% extends "base.html" %}

{% block title %}Análise de Necessidade de Compra - Sistema GERPED{% endblock %}

{% block content %}
<!-- Tabela de Análise de Necessidade de Compra -->
<div class="necessidade-compra-section mb-4">
    <div class="section-header">
        <h3><i class="bi bi-bar-chart icon-text"></i> Análise de Necessidade de Compra</h3>
        <p style="color: #6c757d; font-size: 0.9rem; margin-top: 5px;">
            Baseado nos pedidos liberados pelo Financeiro
        </p>
    </div>
    
    {% if necessidade_compra %}
    <!-- Resumo Total -->
    {% set total_valor_necessidade = necessidade_compra | sum(attribute='valor_total_necessidade') %}
    {% if total_valor_necessidade > 0 %}
    <div class="alert alert-warning necessidade-total-banner">
        <strong><i class="bi bi-cash-stack icon-text"></i> Necessidade Total de Compra:</strong>
        <span>
            {{ "R$ {:,.2f}".format(total_valor_necessidade).replace(',', 'X').replace('.', ',').replace('X', '.') }}
        </span>
    </div>
    {% endif %}
    
    <div class="table-toolbar mb-3">
        <div class="input-group shadow-sm" style="max-width: 360px;">
            <span class="input-group-text bg-white">
                <i class="fas fa-search text-muted"></i>
            </span>
            <input type="search"
                   id="filtroGlobal"
                   class="form-control"
                   placeholder="Buscar por produto, status, valores..." />
        </div>
        <small class="text-muted d-block mt-2">
            Clique nos cabeçalhos para ordenar e use a busca para filtrar rapidamente.
        </small>
    </div>

    <div class="table-responsive">
        <table class="necessidade-table">
            <thead>
                <tr>
                    <th data-column-index="0">PRODUTO</th>
                    <th data-column-index="1">PEDIDOS<br>LIBERADOS</th>
                    <th data-column-index="2">ESTOQUE</th>
                    <th data-column-index="3">SALDO</th>
                    <th data-column-index="4">NECESSIDADE<br>DE COMPRA</th>
                    <th data-column-index="5">VALOR<br>UNITÁRIO</th>
                    <th data-column-index="6">VALOR<br>TOTAL</th>
                    <th data-column-index="7">STATUS</th>
                </tr>
            </thead>
            <tbody>
                {% for item in necessidade_compra %}
                <tr class="{% if item.status == 'CRÍTICO' %}row-critico{% elif item.status == 'ZERADO' %}row-zerado{% else %}row-ok{% endif %}">
                    <td style="text-align: left; font-weight: 600;">{{ item.produto_nome }}</td>
                    <td>{{ item.quantidade_pedida }}</td>
                    <td>{{ item.quantidade_estoque }}</td>
                    <td class="{% if item.saldo < 0 %}text-danger{% elif item.saldo > 0 %}text-success{% else %}text-warning{% endif %}">
                        {{ item.saldo }}
                    </td>
                    <td class="necessidade-cell">
                        {% if item.necessidade_compra > 0 %}
                            <span class="badge-compra">{{ item.necessidade_compra }} cxs.</span>
                        {% else %}
                            <span style="color: #28a745;">—</span>
                        {% endif %}
                    </td>
                    <td style="text-align: right;">
                        {{ "R$ {:,.2f}".format(item.valor_compra).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                    </td>
                    <td style="text-align: right; font-weight: bold;">
                        {% if item.valor_total_necessidade > 0 %}
                            <span style="color: #dc3545;">
                                {{ "R$ {:,.2f}".format(item.valor_total_necessidade).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                            </span>
                        {% else %}
                            <span style="color: #28a745;">—</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.status == 'CRÍTICO' %}
                            <span class="badge-critico"><i class="bi bi-exclamation-octagon icon-text"></i> CRÍTICO</span>
                        {% elif item.status == 'ZERADO' %}
                            <span class="badge-zerado"><i class="bi bi-exclamation-triangle icon-text"></i> ZERADO</span>
                        {% else %}
                            <span class="badge-ok"><i class="bi bi-check-circle-fill text-success icon-text"></i> SUFICIENTE</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% else %}
    <div style="padding: 30px; text-align: center; background: #f8f9fa; border-radius: 8px;">
        <p style="color: #6c757d; margin: 0;">
            ℹ Nenhum pedido com pagamento aprovado no momento.
        </p>
    </div>
    {% endif %}
</div>

<style>
    .necessidade-compra-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .table-toolbar {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .necessidade-total-banner {
        display: inline-flex !important;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
        font-weight: 600;
        color: #dc3545;
        padding: 10px 16px !important;
        border-left: 4px solid #dc3545;
        width: auto;
        white-space: nowrap;
    }

    .section-header h3 {
        color: #2c3e50;
        margin: 0 0 5px 0;
        font-size: 1.5rem;
    }
    
    .necessidade-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .necessidade-table thead {
        background: #f8f9fa;
    }
    
    .necessidade-table th {
        padding: 12px 16px;
        text-align: center;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        font-size: 0.9rem;
    }
    .necessidade-table th[data-column-index] {
        cursor: pointer;
        user-select: none;
        position: relative;
    }
    .necessidade-table th[data-column-index] .sort-indicator {
        font-size: 0.7rem;
        margin-left: 6px;
        color: #adb5bd;
    }
    .necessidade-table th.sorted-asc,
    .necessidade-table th.sorted-desc {
        color: #0d6efd;
    }
    
    .necessidade-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f4;
        text-align: center;
        font-size: 0.9rem;
    }
    
    .necessidade-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .row-critico {
        background-color: #fff5f5 !important;
    }
    
    .row-critico:hover {
        background-color: #fed7d7 !important;
    }
    
    .row-zerado {
        background-color: #fffbeb !important;
    }
    
    .row-zerado:hover {
        background-color: #fef3c7 !important;
    }
    
    .row-ok {
        background-color: #f0fff4 !important;
    }
    
    .row-ok:hover {
        background-color: #c6f6d5 !important;
    }
    
    .text-danger {
        color: #dc3545;
        font-weight: bold;
    }
    
    .text-success {
        color: #28a745;
        font-weight: bold;
    }
    
    .text-warning {
        color: #ffc107;
        font-weight: bold;
    }
    
    .badge-compra {
        background-color: #dc3545;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .badge-critico {
        background-color: #dc3545;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .badge-zerado {
        background-color: #ffc107;
        color: #000;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .badge-ok {
        background-color: #28a745;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .necessidade-cell {
        text-align: center;
    }
    
    @media (max-width: 768px) {
        .necessidade-table {
            font-size: 0.8rem;
        }
        
        .necessidade-table th,
        .necessidade-table td {
            padding: 8px 12px;
        }
    }
</style>

<script nonce="{{ nonce }}">
document.addEventListener('DOMContentLoaded', () => {
    const tabela = document.querySelector('.necessidade-table');
    if (!tabela) {
        return;
    }
    const tbody = tabela.querySelector('tbody');
    const headers = tabela.querySelectorAll('th[data-column-index]');
    let currentSort = { index: null, direction: 'asc' };

    const parseCellValue = (cell) => {
        const text = cell.textContent.trim()
            .replace(/R\$\s?/i, '')
            .replace(/\./g, '')
            .replace(',', '.');
        const number = parseFloat(text);
        if (!Number.isNaN(number)) {
            return number;
        }
        return cell.textContent.trim().toLowerCase();
    };

    const applySortIndicators = () => {
        headers.forEach((header) => {
            header.classList.remove('sorted-asc', 'sorted-desc');
            const indicator = header.querySelector('.sort-indicator');
            if (indicator) {
                indicator.innerHTML = '';
            }
        });
        const target = headers[currentSort.index];
        if (!target) return;
        target.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
        let indicator = target.querySelector('.sort-indicator');
        if (!indicator) {
            indicator = document.createElement('span');
            indicator.className = 'sort-indicator';
            target.appendChild(indicator);
        }
        indicator.innerHTML = currentSort.direction === 'asc'
            ? '<i class="bi bi-caret-up-fill"></i>'
            : '<i class="bi bi-caret-down-fill"></i>';
    };

    headers.forEach((header, index) => {
        header.addEventListener('click', () => {
            const direction = (currentSort.index === index && currentSort.direction === 'asc') ? 'desc' : 'asc';
            currentSort = { index, direction };

            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort((rowA, rowB) => {
                const a = parseCellValue(rowA.children[index]);
                const b = parseCellValue(rowB.children[index]);
                if (typeof a === 'number' && typeof b === 'number') {
                    return direction === 'asc' ? a - b : b - a;
                }
                return direction === 'asc'
                    ? String(a).localeCompare(String(b))
                    : String(b).localeCompare(String(a));
            });

            rows.forEach((row) => tbody.appendChild(row));
            applySortIndicators();
        });
    });

    const filtroGlobal = document.getElementById('filtroGlobal');
    if (filtroGlobal) {
        filtroGlobal.addEventListener('input', (event) => {
            const termo = event.target.value.trim().toLowerCase();
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row) => {
                const texto = row.textContent.toLowerCase();
                row.style.display = texto.includes(termo) ? '' : 'none';
            });
        });
    }
});
</script>
{% endblock %}
