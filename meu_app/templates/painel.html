{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}

<!-- Filtros -->
<div class="card mb-4">
    <form method="GET" class="filter-form">
        <div class="d-flex gap-3 align-items-end">
            <div class="form-group">
                <label for="mes">Mês</label>
                <select name="mes" id="mes" class="form-control">
                    <option value="1" {% if mes == 1 %}selected{% endif %}>Janeiro</option>
                    <option value="2" {% if mes == 2 %}selected{% endif %}>Fevereiro</option>
                    <option value="3" {% if mes == 3 %}selected{% endif %}>Março</option>
                    <option value="4" {% if mes == 4 %}selected{% endif %}>Abril</option>
                    <option value="5" {% if mes == 5 %}selected{% endif %}>Maio</option>
                    <option value="6" {% if mes == 6 %}selected{% endif %}>Junho</option>
                    <option value="7" {% if mes == 7 %}selected{% endif %}>Julho</option>
                    <option value="8" {% if mes == 8 %}selected{% endif %}>Agosto</option>
                    <option value="9" {% if mes == 9 %}selected{% endif %}>Setembro</option>
                    <option value="10" {% if mes == 10 %}selected{% endif %}>Outubro</option>
                    <option value="11" {% if mes == 11 %}selected{% endif %}>Novembro</option>
                    <option value="12" {% if mes == 12 %}selected{% endif %}>Dezembro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="ano">Ano</label>
                <select name="ano" id="ano" class="form-control">
                    {% for a in range(2020, 2101) %}
                        <option value="{{ a }}" {% if ano == a %}selected{% endif %}>{{ a }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label>&nbsp;</label> <!-- Label vazio para alinhar o botão -->
                <button type="submit" class="btn btn-primary">Filtrar</button>
            </div>
        </div>
    </form>
</div>

<style>
    .necessidade-compra-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .section-header h3 {
        color: #2c3e50;
        margin: 0 0 5px 0;
        font-size: 1.5rem;
    }

    .kpi-section {
        background: #ffffff;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 15px 30px rgba(15, 23, 42, 0.08);
        margin-bottom: 32px;
    }

    .principal-kpis {
        background: transparent;
        box-shadow: none;
        padding: 0;
    }

    .kpi-section .section-header {
        margin-bottom: 16px;
    }

    .kpi-section .section-header p {
        margin: 4px 0 0 0;
        color: #6b7280;
    }

    .kpi-section .kpi-grid {
        margin-bottom: 0;
    }

    .kpi-projecao .kpi-card {
        background: #f8f9ff;
        border: 1px dashed #c5d4ff;
        box-shadow: none;
    }

    .kpi-projecao .kpi-card::before {
        background: linear-gradient(90deg, rgba(99, 102, 241, 0.5), rgba(14, 165, 233, 0.4));
    }

    .kpi-projecao .kpi-subtitle {
        font-weight: 500;
        color: #1d4ed8;
    }

    @media (max-width: 640px) {
        .kpi-card {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
        }

        .kpi-action {
            display: none;
        }
    }
    
    .necessidade-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        margin-top: 20px;
    }
    
    .necessidade-table th {
        background-color: #667eea;
        color: white !important;
        padding: 12px;
        text-align: center;
        font-weight: 600;
        border: 1px solid #5a67d8;
    }
    
    .necessidade-table td {
        padding: 12px;
        border: 1px solid #e9ecef;
        text-align: center;
    }
    
    .necessidade-table tbody tr {
        transition: background-color 0.2s ease;
    }
    
    .necessidade-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .row-critico {
        background-color: #fff5f5 !important;
    }
    
    .row-critico:hover {
        background-color: #ffe5e5 !important;
    }
    
    .row-zerado {
        background-color: #fffbf0 !important;
    }
    
    .row-zerado:hover {
        background-color: #fff3d9 !important;
    }
    
    .row-ok {
        background-color: #f0fff4 !important;
    }
    
    .row-ok:hover {
        background-color: #e0ffe8 !important;
    }
    
    .text-danger {
        color: #dc3545;
        font-weight: bold;
    }
    
    .text-success {
        color: #28a745;
        font-weight: bold;
    }
    
    .text-warning {
        color: #ffc107;
        font-weight: bold;
    }
    
    .badge-compra {
        background-color: #dc3545;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .badge-critico {
        background-color: #dc3545;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .badge-zerado {
        background-color: #ffc107;
        color: #000;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .badge-ok {
        background-color: #28a745;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .necessidade-cell {
        font-size: 1.1rem;
    }
    
    .legenda-necessidade ul {
        list-style: none;
    }
    
    .legenda-necessidade li {
        margin: 5px 0;
        color: #495057;
    }
</style>

<!-- KPIs -->
<div class="kpi-section principal-kpis">
    <div class="kpi-grid">
        <!-- Faturamento -->
        <div class="kpi-card kpi-faturamento" onclick="showDrillDown('faturamento')">
            <div class="kpi-content">
                <h3>Faturamento</h3>
                <div class="kpi-value">{{ faturamento_total | currency_brl }}</div>
                <div class="kpi-subtitle">
                    {% if mes %}
                        {{ ["", "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", 
                            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"][mes] }} / {{ ano }}
                    {% endif %}
                </div>
            </div>
            <div class="kpi-action">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        </div>

        <!-- Verbas Totais -->
        <div class="kpi-card kpi-verbas-totais" onclick="showDrillDown('verbas')">
            <div class="kpi-content">
                <h3>Verbas Totais</h3>
                <div class="kpi-value">{{ total_verbas | currency_brl }}</div>
                <div class="kpi-subtitle">SCANN + Plano + AMBEV + Outras</div>
            </div>
            <div class="kpi-action">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        </div>

        <!-- CPV Total -->
        <div class="kpi-card kpi-cpv" onclick="showDrillDown('cpv')">
            <div class="kpi-content">
                <h3>CPV Total</h3>
                <div class="kpi-value">{{ cpv_total | currency_brl }}</div>
                <div class="kpi-subtitle">Custo dos Produtos Vendidos</div>
            </div>
            <div class="kpi-action">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        </div>

        <!-- Margem de Manobra -->
        <div class="kpi-card kpi-margem" onclick="showDrillDown('margem')">
            <div class="kpi-content">
                <h3>Margem de Manobra</h3>
                <div class="kpi-value">{{ margem_manobra | currency_brl }}</div>
                <div class="kpi-subtitle">
                    {{ "{:.1f}%".format(percentual_margem) }} de margem
                </div>
            </div>
            <div class="kpi-action">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        </div>
    </div>
</div>

<div class="kpi-section kpi-projecao-wrapper">
    <div class="section-header">
        <h3><i class="bi bi-columns-gap icon-text"></i> Projeção - Pedidos Liberados pelo Comercial</h3>
        <p class="text-muted mb-3">KPIs simulando o impacto dos pedidos que já foram liberados pelo comercial neste período.</p>
    </div>
    <div class="kpi-grid kpi-projecao">
        <div class="kpi-card kpi-faturamento" onclick="showDrillDown('faturamento_comercial')">
            <div class="kpi-content">
                <h3>Faturamento Projetado</h3>
                <div class="kpi-value">{{ faturamento_liberados | currency_brl }}</div>
                <div class="kpi-subtitle">{{ pedidos_liberados }} pedidos liberados</div>
            </div>
            <div class="kpi-action">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        </div>

        <div class="kpi-card kpi-verbas-totais" onclick="showDrillDown('projecao_mes')">
            <div class="kpi-content">
                <h3>Projeção Mensal (Faturamento + Margem)</h3>
                <div class="kpi-value">{{ faturamento_projetado_mes | currency_brl }}</div>
                <div class="kpi-subtitle">
                    Margem proj.: {{ margem_projetada_mes | currency_brl }} ({{ "{:.1f}%".format(percentual_margem_projetada) }})
                </div>
            </div>
            <div class="kpi-action">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        </div>

        <div class="kpi-card kpi-cpv" onclick="showDrillDown('cpv_comercial')">
            <div class="kpi-content">
                <h3>CPV Projetado</h3>
                <div class="kpi-value">{{ cpv_liberados | currency_brl }}</div>
                <div class="kpi-subtitle">Base nos itens confirmados</div>
            </div>
            <div class="kpi-action">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        </div>

        <div class="kpi-card kpi-margem" onclick="showDrillDown('margem_comercial')">
            <div class="kpi-content">
                <h3>Margem Projetada</h3>
                <div class="kpi-value">{{ margem_liberados | currency_brl }}</div>
                <div class="kpi-subtitle">{{ "{:.1f}%".format(percentual_margem_liberados) }} de margem</div>
            </div>
            <div class="kpi-action">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        </div>
    </div>
</div>

<!-- Gráfico de Evolução Diária -->
<div class="card mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="bi bi-graph-up icon-text"></i> Evolução do Mês - {{ ["", "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", 
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"][mes] }} / {{ ano }}</h3>
    </div>
    
    <div class="chart-container">
        <canvas id="evolucaoChart" width="400" height="200"></canvas>
    </div>
    
    <div class="chart-legend mt-3">
        <div class="legend-item">
            <div class="legend-color" style="background-color: #28a745;"></div>
            <span>Receita + Verbas</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #dc3545;"></div>
            <span>CPV Total</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #007bff;"></div>
            <span>Margem</span>
        </div>
    </div>
</div>

<!-- Scripts do Dashboard -->
<script nonce="{{ nonce }}" src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script nonce="{{ nonce }}" src="{{ url_for('static', filename='dashboard.js') }}"></script>

<!-- Dados para o JavaScript -->
<script nonce="{{ nonce }}">
    // Dados do dashboard para o JavaScript
    window.dadosEvolucao = {{ dados_evolucao | tojson | safe }};
    window.margemManobra = {{ margem_manobra }};
</script>

{% endblock %}
