{% extends "base.html" %}

{% block title %}Análise de Compra{% endblock %}

{% block content %}
<div class="analise-compra-wrapper">
    <div class="analise-header card">
        <div>
            <h2 class="mb-1">Análise de Compra</h2>
            <p class="text-muted mb-0">Clientes x Pedidos liberados e resumo geral para suporte à tomada de decisão.</p>
        </div>
        <span class="badge bg-warning text-dark px-3 py-2">
            Necessidade projetada: {{ total_necessidade }} unidades
        </span>
    </div>

    <div class="analise-grid">
        <section class="clientes-bloco" style="padding-right: 10px;">
            <header class="bloco-header">
                <div>
                    <h3>Clientes e Pedidos</h3>
                    <p class="text-muted mb-0">Rastreie o que já foi coletado e o que falta por cliente.</p>
                </div>
            </header>

            {% if clientes_pedidos %}
                {% for cliente in clientes_pedidos %}
                <article class="cliente-card">
                    <div class="cliente-card-header">
                        <div>
                            <h4>{{ cliente.cliente_nome }}</h4>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="cliente-table auto-fit-table">
                            <colgroup>
                                <col class="col-produto">
                                <col class="col-pedido">
                                <col class="col-coletado">
                                <col class="col-pendente">
                                <col class="col-paletes">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th class="text-center">Pedido</th>
                                    <th class="text-center">Coletado</th>
                                    <th class="text-center">Pendente</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for produto in cliente.produtos %}
                                <tr class="{% if produto.falta_coletar > 0 %}status-alerta{% else %}status-ok{% endif %}">
                                    <td class="produto-nome">{{ produto.produto_nome }}</td>
                                    <td class="text-center fw-semibold">{{ produto.quantidade }}</td>
                                    <td class="text-center text-success fw-semibold">{{ produto.coletado }}</td>
                                    <td class="text-center text-dark fw-bold">
                                        {{ produto.falta_coletar }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </article>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <p>Nenhum pedido liberado pelo Financeiro até o momento.</p>
                </div>
            {% endif %}
        </section>

        <section class="resumo-bloco">
            <header class="bloco-header">
                <div>
                    <h3>Resumo Consolidado</h3>
                    <p class="text-muted mb-0">Pedidos totais confrontados com estoque e compras/retiradas.</p>
                </div>
            </header>

            <div class="resumo-table-wrapper">
                <table class="resumo-table auto-fit-table">
                    <colgroup>
                        <col class="col-produto">
                        <col class="col-pedido">
                        <col class="col-estoque">
                        <col class="col-comprado">
                        <col class="col-comprar">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Pedidos</th>
                            <th>Estoque</th>
                            <th>Comprado</th>
                            <th>Comprar</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in produtos_resumo %}
                        <tr>
                            <td class="produto-nome">{{ item.produto_nome }}</td>
                            <td class="text-center fw-semibold">{{ item.pedidos }}</td>
                            <td class="text-center text-info">{{ item.estoque }}</td>
                            <td class="text-center text-success">{{ item.comprado }}</td>
                            <td class="text-center text-dark fw-bold">
                                {{ item.comprar }}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">Nenhum produto em acompanhamento.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </section>
    </div>
</div>

<style>
main.main-content {
    padding-left: 15px;
}

.analise-compra-wrapper {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.analise-header {
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}

.analise-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
}

.analise-grid {
    display: grid;
    grid-template-columns: minmax(0, 1.9fr) minmax(0, 2.1fr);
    gap: 20px;
    align-items: start;
}

.clientes-bloco, .resumo-bloco {
    background: #fff;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 10px 25px rgba(15,23,42,0.08);
}

.bloco-header {
    margin-bottom: 16px;
}

.cliente-card {
    border: 1px solid #eef2f7;
    border-radius: 12px;
    margin-bottom: 18px;
    padding: 16px;
    background: #fdfefe;
}

.cliente-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    flex-wrap: wrap;
    gap: 8px;
}

.cliente-table, .resumo-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.cliente-table,
.resumo-table {
    border-collapse: separate;
    border-spacing: 0;
    table-layout: auto;
}

.cliente-table th,
.cliente-table td,
.resumo-table th,
.resumo-table td {
    padding: 6px 8px;
    border: 1px solid #d7e3f7;
}

.cliente-table td:first-child,
.resumo-table td:first-child {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.cliente-table th:first-child,
.cliente-table td:first-child,
.resumo-table th:first-child,
.resumo-table td:first-child {
    border-left-width: 2px;
}

.cliente-table th:last-child,
.cliente-table td:last-child,
.resumo-table th:last-child,
.resumo-table td:last-child {
    border-right-width: 2px;
}

.cliente-table tbody tr:first-child td,
.resumo-table tbody tr:first-child td {
    border-top-width: 2px;
}

.cliente-table tbody tr:last-child td,
.resumo-table tbody tr:last-child td {
    border-bottom-width: 2px;
}

.cliente-table thead th, .resumo-table thead th {
    background: #f8fafc;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.04em;
    color: #64748b;
}

.produto-nome {
    font-weight: 600;
    color: #1f2937;
}

.status-alerta {
    background: #fff7ed;
}

.status-ok {
    background: #f8fffb;
}


.resumo-table-wrapper {
    max-height: 75vh;
    overflow: auto;
}

.empty-state {
    background: #f8fafc;
    padding: 32px;
    text-align: center;
    border-radius: 12px;
    color: #6c757d;
}

.resizable-header {
    position: relative;
    padding-right: 14px;
}

.column-resizer {
    position: absolute;
    top: 0;
    right: 0;
    width: 6px;
    height: 100%;
    cursor: col-resize;
    user-select: none;
}

@media (max-width: 1200px) {
    .analise-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .analise-header {
        flex-direction: column;
        gap: 12px;
    }
}
</style>

<script nonce="{{ nonce }}">
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.auto-fit-table').forEach(function (table) {
        const columns = table.querySelectorAll('colgroup col');
        const headers = table.querySelectorAll('thead th');

        headers.forEach(function (header, index) {
            header.classList.add('resizable-header');
            header.title = 'Duplo clique para AutoFit. Arraste para ajustar manualmente.';

            const handle = document.createElement('span');
            handle.className = 'column-resizer';
            header.appendChild(handle);

            handle.addEventListener('mousedown', function (event) {
                startManualResize(event, table, columns, index);
            });

            header.addEventListener('dblclick', function () {
                autoFitColumn(table, columns, index);
            });
        });
    });
});

function startManualResize(event, table, columns, columnIndex) {
    event.preventDefault();
    const startX = event.pageX;
    const header = event.target.parentElement;
    const startWidth = header.offsetWidth;

    function onMouseMove(moveEvent) {
        const delta = moveEvent.pageX - startX;
        const newWidth = Math.max(60, startWidth + delta);
        applyColumnWidth(table, columns, columnIndex, newWidth);
    }

    function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    }

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
}

function autoFitColumn(table, columns, columnIndex) {
    let maxWidth = 0;
    table.querySelectorAll('tr').forEach(function (row) {
        const cell = row.children[columnIndex];
        if (!cell) {
            return;
        }
        const cellWidth = cell.scrollWidth + 16;
        if (cellWidth > maxWidth) {
            maxWidth = cellWidth;
        }
    });
    applyColumnWidth(table, columns, columnIndex, maxWidth);
}

function applyColumnWidth(table, columns, columnIndex, width) {
    if (columns.length && columns[columnIndex]) {
        columns[columnIndex].style.width = width + 'px';
    }

    table.querySelectorAll('thead th')[columnIndex].style.width = width + 'px';
    table.querySelectorAll('tbody tr').forEach(function (row) {
        const cell = row.children[columnIndex];
        if (cell) {
            cell.style.width = width + 'px';
        }
    });
}
</script>
{% endblock %}
