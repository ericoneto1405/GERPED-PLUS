{% extends "base.html" %}

{% block title %}Controle de Estoque - GERPED{% endblock %}
{% block page_title %}Controle de Estoque{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <h2>Controle de Estoque</h2>
        <div class="header-actions">
            <a href="{{ url_for('estoques.novo_estoque') }}" class="btn btn-primary">
                <span class="icon"><i class="bi bi-plus-lg icon-text"></i></span>
                Adicionar ao Estoque
            </a>
        </div>
    </div>
</div>

<div class="content-section">
    <div class="table-container">
        <div class="table-toolbar">
            <div class="input-group shadow-sm" style="max-width: 360px;">
                <span class="input-group-text bg-white">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="search" id="filtroEstoques" class="form-control" placeholder="Buscar por produto, conferente, status..." />
            </div>
            <small class="text-muted">Clique nos títulos para ordenar e utilize a busca para filtrar rapidamente.</small>
        </div>
        <table class="data-table estoques-table">
            <thead>
                <tr>
                    <th data-column-index="0" class="text-center">Código</th>
                    <th data-column-index="1">Descrição</th>
                    <th data-column-index="2" class="text-end">Estoque Atual</th>
                    <th data-column-index="3">Data de Modificação</th>
                    <th data-column-index="4">Conferente</th>
                    <th data-column-index="5">Status</th>
                    <th class="text-center">Conferido</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for estoque in estoques %}
                <tr>
                    <td class="text-center code-cell">
                        {{ estoque.produto.codigo_interno or '—' }}
                    </td>
                    <td>
                        <div class="product-info">
                            <span class="product-name">{{ estoque.produto.nome }}</span>
                            <a href="{{ url_for('estoques.historico_movimentacao', produto_id=estoque.produto.id) }}" 
                               target="_blank" class="history-link" title="Ver histórico de movimentação">
                                <span class="history-icon"><i class="bi bi-bar-chart icon-text"></i></span>
                            </a>
                        </div>
                    </td>
                    <td class="text-end">
                        <div class="stock-quantity">
                            <strong>{{ estoque.quantidade }}</strong>
                            <span class="stock-label">cxs.</span>
                        </div>
                    </td>
                    <td>{{ estoque.data_modificacao.strftime('%d/%m/%Y %H:%M') if estoque.data_modificacao else 'N/A' }}</td>
                    <td>{{ estoque.conferente }}</td>
                    <td>
                        <span class="status-badge status-{{ estoque.status.lower().replace(' ', '-') }}">
                            {{ estoque.status }}
                        </span>
                    </td>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input inventory-confirm-checkbox" value="{{ estoque.id }}" aria-label="Confirmar inventário para {{ estoque.produto.nome }}">
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="{{ url_for('estoques.editar_estoque', id=estoque.id) }}" class="btn-icon btn-edit" title="Editar">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </a>
                            <a href="{{ url_for('estoques.excluir_estoque', id=estoque.id) }}" class="btn-icon btn-delete" title="Excluir" 
                               onclick="return confirm('Tem certeza que deseja excluir este registro de estoque?')">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="no-data">
                        <div class="empty-state">
                            <span class="empty-icon"><i class="bi bi-box-seam icon-text"></i></span>
                            <p>Nenhum registro de estoque encontrado</p>
                            <a href="{{ url_for('estoques.novo_estoque') }}" class="btn btn-primary">Criar primeiro registro</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="inventory-controls">
            <div id="inventarioFeedback" class="alert d-none" role="alert"></div>
            <button id="btnInventarioAtualizado" type="button" class="btn btn-success">
                <i class="bi bi-clipboard-check icon-text"></i> Inventário Atualizado
            </button>
        </div>
    </div>
</div>

<!-- Modal Confirmação Inventário -->
<div class="modal fade" id="inventarioModal" tabindex="-1" aria-labelledby="inventarioModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inventarioModalLabel">Confirmar Inventário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form id="formInventarioConfirmacao">
                <div class="modal-body">
                    <p class="mb-3">Informe sua senha para registrar que o inventário foi atualizado.</p>
                    <div class="mb-3">
                        <label for="inventoryPassword" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="inventoryPassword" name="password" required minlength="4" autocomplete="current-password">
                    </div>
                    <div id="modalInventarioFeedback" class="alert alert-danger d-none" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check2-circle icon-text"></i> Confirmar Atualização
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.product-info {
    display: flex;
    align-items: center;
    gap: 8px;
}

.product-name {
    font-weight: 600;
    color: #1f2a37;
}

.history-link {
    display: flex;
    align-items: center;
    padding: 4px;
    border-radius: 6px;
    color: #6c757d;
    text-decoration: none;
    transition: background 0.2s ease, color 0.2s ease;
}

.history-link:hover {
    background: #f1f3f4;
    color: #0d6efd;
}

.history-icon {
    font-size: 0.9em;
}

.code-cell {
    font-weight: 600;
    font-size: 0.95em;
    color: #374151;
}

.stock-quantity {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
    font-size: 1.1em;
}

.stock-quantity strong {
    font-size: 1.2em;
}

.stock-label {
    font-size: 0.75em;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.table-toolbar {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: 12px;
}

.estoques-table thead {
    background: #f8f9fa;
}

.estoques-table th,
.estoques-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #f1f3f4;
}

.inventory-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    margin-top: 16px;
}

#inventarioFeedback {
    flex: 1;
    margin: 0;
}

.inventory-confirm-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    border: 2px solid #495057;
    accent-color: #198754;
}

.estoques-table th[data-column-index] {
    cursor: pointer;
    user-select: none;
    position: relative;
    font-weight: 600;
}

.estoques-table th[data-column-index] .sort-indicator {
    font-size: 0.7rem;
    margin-left: 6px;
    color: #adb5bd;
}

.estoques-table th.sorted-asc,
.estoques-table th.sorted-desc {
    color: #0d6efd;
}
</style>
{% endblock %}

{% block scripts %}
<script nonce="{{ nonce }}">
$(document).ready(function() {
    // Inicializar tooltips
    $('[title]').tooltip();
    
    // Adicionar classes para estilização
    $('.quantity-badge').each(function() {
        var quantity = parseInt($(this).text());
        if (quantity <= 10) {
            $(this).addClass('low-stock');
        } else if (quantity <= 50) {
            $(this).addClass('medium-stock');
        } else {
            $(this).addClass('high-stock');
        }
    });
});

document.addEventListener('DOMContentLoaded', () => {
    const tabela = document.querySelector('.estoques-table');
    if (!tabela) return;

    const tbody = tabela.querySelector('tbody');
    const headers = tabela.querySelectorAll('th[data-column-index]');
    const filtro = document.getElementById('filtroEstoques');
    const inventoryButton = document.getElementById('btnInventarioAtualizado');
    const inventoryFeedback = document.getElementById('inventarioFeedback');
    const modalElement = document.getElementById('inventarioModal');
    const modalInstance = modalElement && window.bootstrap ? new window.bootstrap.Modal(modalElement) : null;
    const modalFeedback = document.getElementById('modalInventarioFeedback');
    const passwordInput = document.getElementById('inventoryPassword');
    const confirmForm = document.getElementById('formInventarioConfirmacao');
    const confirmarInventarioUrl = "{{ url_for('estoques.confirmar_inventario') }}";
    const storageAvailable = (() => {
        try {
            if (typeof window === 'undefined' || !window.localStorage) {
                return false;
            }
            const testKey = '__estoques_storage_test__';
            window.localStorage.setItem(testKey, '1');
            window.localStorage.removeItem(testKey);
            return true;
        } catch (error) {
            console.warn('Persistência local indisponível:', error);
            return false;
        }
    })();
    const STORAGE_KEYS = {
        filtro: 'estoques.filtroBusca',
        checkbox: 'estoques.checkboxState'
    };
    let currentSort = { index: null, direction: 'asc' };

    if (modalElement && passwordInput) {
        modalElement.addEventListener('shown.bs.modal', () => {
            passwordInput.focus();
        });
    }

    const setFeedback = (element, message = '', type = 'danger') => {
        if (!element) return;
        element.classList.remove('alert-danger', 'alert-success', 'alert-info', 'alert-warning');
        if (!message) {
            element.classList.add('d-none');
            element.textContent = '';
            return;
        }
        element.textContent = message;
        element.classList.remove('d-none');
        element.classList.add(`alert-${type}`);
    };

    const getCheckboxes = () => Array.from(document.querySelectorAll('.inventory-confirm-checkbox'));

    const loadCheckboxState = () => {
        if (!storageAvailable) return {};
        try {
            const raw = window.localStorage.getItem(STORAGE_KEYS.checkbox);
            return raw ? JSON.parse(raw) : {};
        } catch (error) {
            console.warn('Não foi possível carregar o estado das checkboxes:', error);
            return {};
        }
    };

    const persistCheckboxState = (state) => {
        if (!storageAvailable) return;
        try {
            window.localStorage.setItem(STORAGE_KEYS.checkbox, JSON.stringify(state));
        } catch (error) {
            console.warn('Não foi possível salvar o estado das checkboxes:', error);
        }
    };

    const checkboxState = loadCheckboxState();

    const sincronizarCheckboxes = () => {
        const checkboxes = getCheckboxes();
        const idsAtuais = new Set();
        checkboxes.forEach((checkbox) => {
            const id = checkbox.value;
            idsAtuais.add(id);
            if (Object.prototype.hasOwnProperty.call(checkboxState, id)) {
                checkbox.checked = Boolean(checkboxState[id]);
            }
            checkbox.addEventListener('change', () => {
                checkboxState[id] = checkbox.checked;
                persistCheckboxState(checkboxState);
            });
        });
        Object.keys(checkboxState).forEach((id) => {
            if (!idsAtuais.has(id)) {
                delete checkboxState[id];
            }
        });
        persistCheckboxState(checkboxState);
    };

    const parseValue = (cell, index) => {
        if (index === 1) {
            // datas no formato dd/mm/yyyy hh:mm
            const text = cell.textContent.trim();
            const [data, hora] = text.split(' ');
            if (!data || !hora) return text.toLowerCase();
            const [dia, mes, ano] = data.split('/');
            const value = `${ano}-${mes}-${dia} ${hora}`;
            return value;
        }
        return cell.textContent.trim().toLowerCase();
    };

    const applySortIndicators = () => {
        headers.forEach((header) => {
            header.classList.remove('sorted-asc', 'sorted-desc');
            let indicator = header.querySelector('.sort-indicator');
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.className = 'sort-indicator';
                header.appendChild(indicator);
            }
            indicator.innerHTML = '';
        });

        const target = headers[currentSort.index];
        if (!target) return;
        let indicator = target.querySelector('.sort-indicator');
        if (!indicator) {
            indicator = document.createElement('span');
            indicator.className = 'sort-indicator';
            target.appendChild(indicator);
        }
        target.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
        indicator.innerHTML = currentSort.direction === 'asc'
            ? '<i class="bi bi-caret-up-fill"></i>'
            : '<i class="bi bi-caret-down-fill"></i>';
    };

    const sortRows = (index, direction) => {
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((rowA, rowB) => {
            const a = parseValue(rowA.children[index], index);
            const b = parseValue(rowB.children[index], index);

            if (typeof a === 'number' && typeof b === 'number') {
                return direction === 'asc' ? a - b : b - a;
            }
            return direction === 'asc'
                ? String(a).localeCompare(String(b))
                : String(b).localeCompare(String(a));
        });

        rows.forEach((row) => tbody.appendChild(row));
        applySortIndicators();
    };

    headers.forEach((header, index) => {
        header.addEventListener('click', () => {
            const direction = (currentSort.index === index && currentSort.direction === 'asc') ? 'desc' : 'asc';
            currentSort = { index, direction };
            sortRows(index, direction);
        });
    });

    if (filtro) {
        const aplicarFiltro = (valor) => {
            const termo = valor.trim().toLowerCase();
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row) => {
                const texto = row.textContent.toLowerCase();
                row.style.display = texto.includes(termo) ? '' : 'none';
            });
        };

        filtro.addEventListener('input', (event) => {
            aplicarFiltro(event.target.value || '');
            if (storageAvailable) {
                try {
                    window.localStorage.setItem(STORAGE_KEYS.filtro, event.target.value);
                } catch (error) {
                    console.warn('Não foi possível salvar o filtro de estoques:', error);
                }
            }
        });

        if (storageAvailable) {
            try {
                const savedFilter = window.localStorage.getItem(STORAGE_KEYS.filtro) || '';
                if (savedFilter) {
                    filtro.value = savedFilter;
                    aplicarFiltro(savedFilter);
                }
            } catch (error) {
                console.warn('Não foi possível restaurar o filtro de estoques:', error);
            }
        }
    }
    sincronizarCheckboxes();

    if (inventoryButton) {
        inventoryButton.addEventListener('click', () => {
            const checkboxes = getCheckboxes();
            if (!checkboxes.length) {
                setFeedback(inventoryFeedback, 'Não há itens de estoque para confirmar.', 'info');
                return;
            }
            const algumDesmarcado = checkboxes.some((checkbox) => !checkbox.checked);
            if (algumDesmarcado) {
                setFeedback(inventoryFeedback, 'Marque todos os itens antes de finalizar o inventário.', 'danger');
                return;
            }
            setFeedback(inventoryFeedback, '');
            if (modalInstance) {
                setFeedback(modalFeedback, '');
                if (passwordInput) {
                    passwordInput.value = '';
                    passwordInput.focus();
                }
                modalInstance.show();
            }
        });
    }

    if (confirmForm) {
        confirmForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!passwordInput) return;
            const senha = passwordInput.value.trim();
            if (!senha) {
                setFeedback(modalFeedback, 'Informe sua senha para confirmar.', 'danger');
                return;
            }

            const checkboxes = getCheckboxes();
            const estoqueIds = checkboxes.map((checkbox) => checkbox.value);
            const submitButton = confirmForm.querySelector('button[type="submit"]');
            const originalLabel = submitButton ? submitButton.innerHTML : '';
            let confirmSuccess = false;

            try {
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Confirmando...';
                }

                const response = await fetch(confirmarInventarioUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.CSRF_TOKEN
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ password: senha, estoque_ids: estoqueIds })
                });

                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Não foi possível confirmar o inventário.');
                }

                setFeedback(modalFeedback, '');
                if (modalInstance) {
                    modalInstance.hide();
                }
                setFeedback(inventoryFeedback, result.message || 'Inventário confirmado com sucesso.', 'success');
                confirmSuccess = true;
                setTimeout(() => window.location.reload(), 1500);
            } catch (error) {
                setFeedback(modalFeedback, error.message, 'danger');
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalLabel;
                }
                if (confirmSuccess) {
                    confirmForm.reset();
                }
            }
        });
    }
});
</script>
{% endblock %}
