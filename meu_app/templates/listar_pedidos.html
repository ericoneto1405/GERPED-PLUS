{% extends 'base.html' %}

{% block title %}Listar Pedidos{% endblock %}

{% block content %}
    <div class="page-header">
        <div class="header-title">
            <h2><i class="bi bi-clipboard icon-text"></i> Todos os Pedidos</h2>
            <div class="page-actions">
                {# --- Importacao em massa (DESATIVADA) ---
                   Removido da interface por decisao de negocio.
                   Mantido comentado para referencia futura.
                #}
                {#
                <form id="formImportarHistorico" class="action-form" method="POST" action="{{ url_for('pedidos.importar_historico') }}" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <label for="arquivoHistorico" class="sr-only">Selecionar arquivo histórico</label>
                    <input type="file" name="arquivo" id="arquivoHistorico" accept=".csv,.xlsx,.xls" style="display:none">
                    <button type="button" class="action-chip action-chip-primary" id="btnImportarHistorico">
                        <i class="bi bi-upload"></i>
                        <span>Importar Histórico</span>
                    </button>
                </form>
                <a href="{{ url_for('pedidos.download_modelo_pedidos') }}" class="action-chip action-chip-ghost">
                    <i class="bi bi-file-earmark-arrow-down"></i>
                    <span>Baixar modelo</span>
                </a>
                <form id="formEstornarImportacao" class="action-form" method="POST" action="{{ url_for('pedidos.estornar_importacao') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="action-chip action-chip-danger" id="btnEstornarImportacao">
                        <i class="bi bi-arrow-counterclockwise"></i>
                        <span>Estornar importação</span>
                    </button>
                </form>
                #}
            </div>
        </div>
        <a href="{{ url_for('pedidos.novo_pedido') }}" class="btn-primary"><i class="bi bi-plus-lg icon-text"></i> Novo Pedido</a>
</div>

<form method="get" class="filtro-form">
    <div class="form-group">
        <label for="filtroStatus">Status:</label>
        <select name="filtro" id="filtroStatus" class="form-control">
            <option value="todos" {% if filtro == 'todos' %}selected{% endif %}>Todos</option>
            <option value="aguardando_financeiro" {% if filtro == 'aguardando_financeiro' %}selected{% endif %}>Aguardando Financeiro</option>
            <option value="liberado_coleta" {% if filtro == 'liberado_coleta' %}selected{% endif %}>Liberado para Coleta</option>
            <option value="coletado_parcial" {% if filtro == 'coletado_parcial' %}selected{% endif %}>Coletado (parcial ou total)</option>
        </select>
    </div>

    <div class="date-range">
        <div class="form-group">
            <label for="data_inicio">Data Inicial:</label>
            <div class="date-input-wrapper">
                <input type="text" name="data_inicio" value="{{ data_inicio }}" id="data_inicio" class="form-control" placeholder="DD/MM/AAAA" inputmode="numeric" autocomplete="off">
                <button type="button" class="date-picker-btn" data-target="data_inicio" aria-label="Abrir calendário">
                    <i class="bi bi-calendar-event icon-text"></i>
                </button>
                <input type="date" id="data_inicio_picker" class="date-picker-hidden" tabindex="-1" aria-hidden="true">
            </div>
        </div>

        <div class="form-group">
            <label for="data_fim">Data Final:</label>
            <div class="date-input-wrapper">
                <input type="text" name="data_fim" value="{{ data_fim }}" id="data_fim" class="form-control" placeholder="DD/MM/AAAA" inputmode="numeric" autocomplete="off">
                <button type="button" class="date-picker-btn" data-target="data_fim" aria-label="Abrir calendário">
                    <i class="bi bi-calendar-event icon-text"></i>
                </button>
                <input type="date" id="data_fim_picker" class="date-picker-hidden" tabindex="-1" aria-hidden="true">
            </div>
        </div>

        <div class="divider-text">OU</div>

        <div class="form-group">
            <label for="mes_ano">Mês/Ano Inteiro:</label>
            <input type="month" name="mes_ano" id="mes_ano" value="{{ mes_ano }}" class="form-control">
        </div>
    </div>

    <div class="form-group" style="flex-direction: row; gap: 10px; align-items: center;">
        <span class="sr-only">Filtrar</span>
        <button type="submit" class="btn-primary">Filtrar</button>
        <button type="button" class="btn-secondary" id="btnLimparFiltros">Limpar filtros</button>
    </div>
</form>

<style nonce="{{ nonce }}">
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .page-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
    }

    .action-form {
        display: inline-flex;
        margin: 0;
    }

    .action-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 999px;
        border: 1px solid var(--border-color);
        background: #fff;
        color: var(--text-primary);
        font-size: 0.9rem;
        font-weight: 600;
        text-decoration: none;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .action-chip:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
        text-decoration: none;
    }

    .action-chip-primary {
        background: var(--accent-purple);
        border-color: transparent;
        color: #fff;
    }

    .date-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .date-picker-btn {
        position: absolute;
        right: 6px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        padding: 4px 6px;
        cursor: pointer;
    }

    .date-picker-btn:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }

    .date-picker-hidden {
        position: absolute;
        opacity: 0;
        width: 1px;
        height: 1px;
        pointer-events: none;
    }

    .action-chip-primary:hover {
        background: var(--accent-purple-light);
    }

    .action-chip-ghost {
        color: var(--text-primary);
    }

    .action-chip-ghost:hover {
        color: var(--accent-purple);
        border-color: var(--accent-purple);
    }

    .action-chip-danger {
        background: #fff8f7;
        border-color: rgba(239, 68, 68, 0.4);
        color: var(--danger-color);
    }

    .action-chip-danger:hover {
        background: #fee2e2;
        border-color: var(--danger-color);
    }

    .loading-upload {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: #fff;
        z-index: 9999;
    }
    .loading-upload .spinner {
        width: 42px;
        height: 42px;
        border: 4px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    .loading-upload p {
        margin-top: 12px;
        font-weight: 600;
        letter-spacing: 0.02em;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0,0,0,0);
        border: 0;
    }

    .btn-primary {
        background: var(--accent-purple);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        background: var(--accent-purple-light);
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-1px);
    }

    .filtro-form {
        margin-bottom: 20px;
        display: flex;
        align-items: flex-end;
        gap: 15px;
        flex-wrap: wrap;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-control {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        min-width: 200px;
    }

    .date-range {
        display: flex;
        align-items: flex-end;
        gap: 15px;
    }

    .divider-text {
        margin-bottom: 8px;
        font-weight: bold;
        color: #6c757d;
    }

    .table-toolbar {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 16px;
    }

    .pedidos-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        table-layout: auto;
        margin-bottom: 30px;
    }

    .pedidos-table th,
    .pedidos-table td {
        padding: 10px 12px;
        border: 1px solid #d7e3f7;
        font-size: 0.9rem;
        text-align: center;
    }

    .pedidos-table th:first-child,
    .pedidos-table td:first-child {
        border-left-width: 2px;
    }

    .pedidos-table th:last-child,
    .pedidos-table td:last-child {
        border-right-width: 2px;
    }

    .pedidos-table tbody tr:first-child td {
        border-top-width: 2px;
    }

    .pedidos-table tbody tr:last-child td {
        border-bottom-width: 2px;
    }

    .pedidos-table thead th {
        background: #f8fafc;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #64748b;
        font-weight: 700;
        cursor: pointer;
        user-select: none;
        position: relative;
    }

    .pedidos-table thead th .sort-indicator {
        font-size: 0.7rem;
        margin-left: 6px;
        color: #adb5bd;
    }

    .total-resume-wrapper {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-bottom: 8px;
        flex-wrap: wrap;
    }

    .valor-total-card {
        min-width: 240px;
        padding: 10px 14px;
        border-radius: 12px;
        background: linear-gradient(135deg, #eef2ff 0%, #dbeafe 100%);
        border: 1px solid #c7d2fe;
        display: flex;
        flex-direction: column;
        gap: 4px;
        text-align: right;
        box-shadow: 0 5px 14px rgba(79,70,229,0.15);
    }

    .valor-total-card span {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #475569;
    }

    .valor-total-card strong {
        font-size: 1.1rem;
        color: #111827;
    }

    .valor-total-card.investimento {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-color: #fca5a5;
        box-shadow: 0 5px 14px rgba(239, 68, 68, 0.2);
    }

    .valor-total-card.pequeno {
        min-width: 160px;
        padding: 8px 12px;
    }

    .valor-total-card.pequeno span {
        font-size: 0.72rem;
    }

    .valor-total-card.pequeno strong {
        font-size: 1rem;
    }

    .pedidos-table th.sorted-asc,
    .pedidos-table th.sorted-desc {
        color: #0d6efd;
    }

    .pedidos-table tbody tr:hover td {
        background: #f8f9fa;
    }

    .pedidos-table .col-id { width: 7%; }
    .pedidos-table .col-cliente { width: 22%; }
    .pedidos-table .col-data { width: 16%; }
    .pedidos-table .col-valor { width: 12%; }
    .pedidos-table .col-investimento { width: 12%; }
    .pedidos-table .col-status { width: 12%; }
    .pedidos-table .col-ver { width: 9%; }
    .pedidos-table .col-acoes { width: 10%; }

    .resizable-header {
        position: relative;
        padding-right: 14px;
        user-select: none;
    }

    .column-resizer {
        position: absolute;
        top: 0;
        right: 0;
        width: 6px;
        height: 100%;
        cursor: col-resize;
        user-select: none;
    }

    .status-ok {
        color: green;
        font-weight: bold;
    }

    .status-pendente {
        color: red;
        font-weight: bold;
    }

    .status-comercial {
        color: #ffc107;
        font-weight: bold;
        background-color: rgba(255, 193, 7, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
    }
    
    /* Estilo específico para o botão VER */
    .botao-ver {
        display: inline-block !important;
        padding: 8px 16px !important;
        background-color: #007bff !important;
        color: white !important;
        text-decoration: none !important;
        border-radius: 4px !important;
        font-weight: 500 !important;
        transition: all 0.2s ease !important;
        border: none !important;
        cursor: pointer !important;
        font-size: 14px !important;
        line-height: 1.2 !important;
        min-width: 60px !important;
        text-align: center !important;
    }
    
    .botao-ver:hover {
        background-color: #0056b3 !important;
        color: white !important;
        text-decoration: none !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
    }
    
    /* Garantir que a célula da tabela seja visível */
    td:has(.botao-ver) {
        padding: 8px !important;
        text-align: center !important;
        vertical-align: middle !important;
    }
    
    /* Forçar visibilidade do botão */
    .botao-ver {
        position: relative !important;
        z-index: 10 !important;
        pointer-events: auto !important;
    }
    
    /* Debug: destacar o botão */
    .botao-ver {
        border: 2px solid red !important;
        background-color: #ff0000 !important;
    }

    .status-financeiro {
        color: #28a745;
        font-weight: bold;
        background-color: rgba(40, 167, 69, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
    }

    .status-coleta {
        color: #0d6efd;
        font-weight: bold;
        background-color: rgba(13, 110, 253, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
    }

    .status-cancelado {
        color: #b02a37;
        font-weight: bold;
        background-color: rgba(220, 53, 69, 0.08);
        padding: 4px 8px;
        border-radius: 4px;
    }

    .icon-svg {
        height: 16px;
        fill: currentColor;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
    }

    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s ease;
    }

    .close:hover {
        color: #2c3e50;
    }

    .modal-body {
        margin-bottom: 25px;
    }

    .modal-message {
        font-size: 1rem;
        color: #6c757d;
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
    }

    .form-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s ease;
        box-sizing: border-box;
    }

    .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }

    .btn-primary {
        background-color: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background-color: #5a67d8;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .error-message {
        color: #dc3545;
        font-size: 0.9rem;
        margin-top: 8px;
        display: none;
    }

    .loading {
        display: none;
        text-align: center;
        margin-top: 10px;
    }

    .spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

</style>

<div class="table-toolbar" style="margin-bottom: 16px;">
    <div class="input-group shadow-sm" style="max-width: 360px;">
        <span class="input-group-text bg-white">
            <i class="fas fa-search text-muted"></i>
        </span>
        <input type="search" id="filtroPedidos" class="form-control" placeholder="Buscar por cliente, status, valor..." />
    </div>
    <small class="text-muted">Clique nos cabeçalhos para ordenar e use a busca para filtrar rapidamente.</small>
</div>

<div class="total-resume-wrapper">
    <div class="valor-total-card">
        <span>Total filtrado</span>
        <strong>{{ (total_pedidos_filtrados or 0) | currency_brl }}</strong>
    </div>
    <div class="valor-total-card investimento">
        <span>Total filtrado investimento</span>
        <strong>{{ (total_investimento_filtrado or 0) | currency_brl }}</strong>
    </div>
    <div class="valor-total-card pequeno investimento">
        <span>% investimento</span>
        <strong>{{ (percentual_investimento or 0) | number_brl }}%</strong>
    </div>
</div>

<table class="pedidos-table auto-fit-table">
    <colgroup>
        <col class="col-id">
        <col class="col-cliente">
        <col class="col-data">
        <col class="col-valor">
        <col class="col-investimento">
        <col class="col-status">
        <col class="col-ver">
        <col class="col-acoes">
    </colgroup>
    <thead>
        <tr>
            <th data-column-index="0" data-sort-field="id" class="{% if current_sort == 'id' %}sorted-{{ current_direction }}{% endif %}">
                #
                <span class="sort-indicator">
                    {% if current_sort == 'id' %}
                        <i class="bi bi-caret-{{ 'up' if current_direction == 'asc' else 'down' }}-fill"></i>
                    {% endif %}
                </span>
            </th>
            <th data-column-index="1" data-sort-field="cliente" class="{% if current_sort == 'cliente' %}sorted-{{ current_direction }}{% endif %}">
                CLIENTE
                <span class="sort-indicator">
                    {% if current_sort == 'cliente' %}
                        <i class="bi bi-caret-{{ 'up' if current_direction == 'asc' else 'down' }}-fill"></i>
                    {% endif %}
                </span>
            </th>
            <th data-column-index="2" data-sort-field="data" class="{% if current_sort == 'data' %}sorted-{{ current_direction }}{% endif %}">
                DATA E HORA
                <span class="sort-indicator">
                    {% if current_sort == 'data' %}
                        <i class="bi bi-caret-{{ 'up' if current_direction == 'asc' else 'down' }}-fill"></i>
                    {% endif %}
                </span>
            </th>
            <th data-column-index="3" data-sort-field="valor" class="{% if current_sort == 'valor' %}sorted-{{ current_direction }}{% endif %}">
                VALOR DO PEDIDO
                <span class="sort-indicator">
                    {% if current_sort == 'valor' %}
                        <i class="bi bi-caret-{{ 'up' if current_direction == 'asc' else 'down' }}-fill"></i>
                    {% endif %}
                </span>
            </th>
            <th data-column-index="4" data-sort-field="investimento" class="{% if current_sort == 'investimento' %}sorted-{{ current_direction }}{% endif %}">
                SALDO INVESTIMENTO
                <span class="sort-indicator">
                    {% if current_sort == 'investimento' %}
                        <i class="bi bi-caret-{{ 'up' if current_direction == 'asc' else 'down' }}-fill"></i>
                    {% endif %}
                </span>
            </th>
            <th data-column-index="5" data-sort-field="status" class="{% if current_sort == 'status' %}sorted-{{ current_direction }}{% endif %}">
                STATUS
                <span class="sort-indicator">
                    {% if current_sort == 'status' %}
                        <i class="bi bi-caret-{{ 'up' if current_direction == 'asc' else 'down' }}-fill"></i>
                    {% endif %}
                </span>
            </th>
            <th>VER PEDIDO</th>
            <th>AÇÕES</th>
        </tr>
    </thead>
    <tbody>
        {% for item in pedidos %}
        <tr id="linha-pedido-{{ item.pedido.id }}">
            <td>#{{ item.pedido.numero_exibicao }}</td>
            <td>{{ item.pedido.cliente.nome }}</td>
            <td>
                <span class="js-utc" data-utc="{{ item.pedido.data|datetime_utc_iso }}" data-format="DD/MM/YYYY HH:mm">
                    {{ item.pedido.data.strftime('%d/%m/%Y %H:%M') }}
                </span>
            </td>
            <td>{{ item.total_venda | currency_brl }}</td>
            <td>{{ (item.saldo_investimento or 0) | currency_brl }}</td>
            <td class="{% if item.status_codigo == 'liberado_coleta' %}status-financeiro{% elif item.status_codigo in ['coletado_parcial', 'coleta_concluida'] %}status-coleta{% elif item.status_codigo == 'cancelado' %}status-cancelado{% else %}status-pendente{% endif %}">
                {{ item.status }}
            </td>
            <td>
                <a href="{{ url_for('pedidos.visualizar_pedido', id=item.pedido.id, origem='pedidos', filtro=filtro, data_inicio=data_inicio, data_fim=data_fim, sort=current_sort, direction=current_direction) }}"
                   class="botao-ver">
                    <i class="bi bi-eye icon-text"></i> Ver
                </a>
            </td>
            <td>
                <div class="action-icons">
                    {% if not item.pedido.confirmado_comercial %}
                    <button data-action="confirmar" data-pedido-id="{{ item.pedido.id }}" class="icon-btn icon-confirm" title="Confirmar pedido (Comercial)">
                        <svg class="icon-svg" viewBox="0 0 24 24">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                        </svg>
                    </button>
                    {% endif %}
                    <button data-action="editar" data-pedido-id="{{ item.pedido.id }}" class="icon-btn icon-edit" title="Editar pedido">
                        <svg class="icon-svg" viewBox="0 0 24 24">
                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                        </svg>
                    </button>
                    <button data-action="excluir" data-pedido-id="{{ item.pedido.id }}" class="icon-btn icon-delete" title="Excluir pedido">
                        <svg class="icon-svg" viewBox="0 0 24 24">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            </td>
        </tr>
        {% else %}
        <tr><td colspan="8">Nenhum pedido encontrado com os filtros aplicados.</td></tr>
        {% endfor %}
    </tbody>
</table>

<!-- Modal de Confirmação -->
<div id="modalConfirmacao" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle"><i class="bi bi-shield-lock icon-text"></i> Confirmação de Senha</h3>
            <span class="close" id="btnFecharModal">&times;</span>
        </div>
        <div class="modal-body">
            <p class="modal-message" id="modalMessage">
                Para continuar com esta ação, é necessário inserir a senha do administrador.
            </p>
            <form id="formSenha">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <label for="senhaAdmin">Senha do Administrador:</label>
                    <input type="password" id="senhaAdmin" name="senha" required>
                    <div class="error-message" id="errorMessage"></div>
                </div>
            </form>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Verificando senha...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="btnCancelar">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnConfirmar">Confirmar</button>
        </div>
    </div>
</div>

<a href="{{ url_for('main.painel') }}" class="botao"><i class="bi bi-arrow-left icon-text"></i> Voltar ao Painel</a>

{# Importacao em massa (DESATIVADA): overlay de upload #}
{#
<div class="loading-upload" id="loadingUpload">
    <div class="spinner"></div>
    <p>Enviando histórico...</p>
</div>
#}

<script nonce="{{ nonce }}">
let acaoAtual = '';
let pedidoId = null;

// Importacao em massa (DESATIVADA): Importar histórico direto
/*
document.addEventListener('DOMContentLoaded', () => {
    const btnImportarHistorico = document.getElementById('btnImportarHistorico');
    const inputHistorico = document.getElementById('arquivoHistorico');
    const formHistorico = document.getElementById('formImportarHistorico');
    const overlay = document.getElementById('loadingUpload');
    if (btnImportarHistorico && inputHistorico && formHistorico) {
        btnImportarHistorico.addEventListener('click', () => inputHistorico.click());
        inputHistorico.addEventListener('change', () => {
            if (inputHistorico.files.length > 0) {
                if (overlay) overlay.style.display = 'flex';
                formHistorico.submit();
            }
        });
    }
});
*/

// Persistência de filtros
document.addEventListener('DOMContentLoaded', () => {
    const storageKey = 'pedidosFiltros';
    const filtroStatus = document.getElementById('filtroStatus');
    const dataInicioInput = document.getElementById('data_inicio');
    const dataFimInput = document.getElementById('data_fim');
    const dataInicioPicker = document.getElementById('data_inicio_picker');
    const dataFimPicker = document.getElementById('data_fim_picker');
    const datePickerButtons = Array.from(document.querySelectorAll('.date-picker-btn'));
    const mesAnoInput = document.getElementById('mes_ano');
    const buscaInput = document.getElementById('filtroPedidos');

    const inputs = [filtroStatus, dataInicioInput, dataFimInput, mesAnoInput, buscaInput];

    function formatarDataBR(valorIso) {
        if (!valorIso) return '';
        const match = String(valorIso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!match) return valorIso;
        return `${match[3]}/${match[2]}/${match[1]}`;
    }

    function normalizarParaIso(valor) {
        if (!valor) return '';
        const raw = String(valor).trim();
        const brMatch = raw.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (brMatch) {
            return `${brMatch[3]}-${brMatch[2]}-${brMatch[1]}`;
        }
        return raw;
    }

    function abrirPicker(targetInput, pickerInput) {
        if (!targetInput || !pickerInput) return;
        const valorIso = normalizarParaIso(targetInput.value);
        if (valorIso.match(/^\d{4}-\d{2}-\d{2}$/)) {
            pickerInput.value = valorIso;
        }
        if (typeof pickerInput.showPicker === 'function') {
            pickerInput.showPicker();
        } else {
            pickerInput.focus();
            pickerInput.click();
        }
    }

    function configurarPickers() {
        datePickerButtons.forEach((btn) => {
            const targetId = btn.getAttribute('data-target');
            const targetInput = document.getElementById(targetId);
            const pickerInput = document.getElementById(`${targetId}_picker`);
            btn.addEventListener('click', () => abrirPicker(targetInput, pickerInput));
        });

        if (dataInicioPicker && dataInicioInput) {
            dataInicioPicker.addEventListener('change', () => {
                dataInicioInput.value = formatarDataBR(dataInicioPicker.value);
            });
        }
        if (dataFimPicker && dataFimInput) {
            dataFimPicker.addEventListener('change', () => {
                dataFimInput.value = formatarDataBR(dataFimPicker.value);
            });
        }
    }

    function loadFilters() {
        try {
            const stored = JSON.parse(localStorage.getItem(storageKey));
            if (!stored) return;
            if (filtroStatus && !filtroStatus.value && stored.status) filtroStatus.value = stored.status;
            if (dataInicioInput && !dataInicioInput.value && stored.data_inicio) {
                dataInicioInput.value = formatarDataBR(stored.data_inicio);
            }
            if (dataFimInput && !dataFimInput.value && stored.data_fim) {
                dataFimInput.value = formatarDataBR(stored.data_fim);
            }
            if (mesAnoInput && !mesAnoInput.value && stored.mes_ano) mesAnoInput.value = stored.mes_ano;
            if (buscaInput && !buscaInput.value && stored.busca) buscaInput.value = stored.busca;
        } catch (err) {
            console.warn('Não foi possível carregar filtros salvos:', err);
        }
    }

    function normalizarDataInput(input) {
        if (!input) return;
        const valorIso = normalizarParaIso(input.value);
        input.value = valorIso;
    }

    function saveFilters() {
        const payload = {
            status: filtroStatus ? filtroStatus.value : '',
            data_inicio: dataInicioInput ? dataInicioInput.value : '',
            data_fim: dataFimInput ? dataFimInput.value : '',
            mes_ano: mesAnoInput ? mesAnoInput.value : '',
            busca: buscaInput ? buscaInput.value : ''
        };
        localStorage.setItem(storageKey, JSON.stringify(payload));
    }

    loadFilters();
    configurarPickers();
    if (dataInicioInput && dataInicioInput.value) {
        dataInicioInput.value = formatarDataBR(dataInicioInput.value);
    }
    if (dataFimInput && dataFimInput.value) {
        dataFimInput.value = formatarDataBR(dataFimInput.value);
    }
    saveFilters(); // garante que valores atuais do servidor permaneçam

    inputs.forEach(el => {
        if (!el) return;
        const eventName = el.tagName === 'SELECT' ? 'change' : 'input';
        el.addEventListener(eventName, saveFilters);
    });

    const filtroForm = document.querySelector('.filtro-form');
    if (filtroForm) {
        filtroForm.addEventListener('submit', () => {
            normalizarDataInput(dataInicioInput);
            normalizarDataInput(dataFimInput);
            saveFilters();
        });
    }

    const btnLimpar = document.getElementById('btnLimparFiltros');
    if (btnLimpar) {
        btnLimpar.addEventListener('click', () => {
            [filtroStatus, dataInicioInput, dataFimInput, mesAnoInput, buscaInput].forEach(el => {
                if (!el) return;
                if (el.tagName === 'SELECT') {
                    el.selectedIndex = 0;
                } else {
                    el.value = '';
                }
            });
            localStorage.removeItem(storageKey);
            window.location = "{{ url_for('pedidos.listar_pedidos') }}";
        });
    }
});

document.addEventListener('DOMContentLoaded', () => {
    const btnEstornar = document.getElementById('btnEstornarImportacao');
    if (btnEstornar) {
        btnEstornar.addEventListener('click', (event) => {
            if (!confirm('Isso vai remover os pedidos importados. Deseja continuar?')) {
                event.preventDefault();
            }
        });
    }
});

// Alternância de ordenação (server-side)
document.addEventListener('DOMContentLoaded', () => {
    const headers = document.querySelectorAll('.pedidos-table th[data-sort-field]');
    const currentSortField = "{{ current_sort }}";
    const currentDirection = "{{ current_direction }}";
    headers.forEach(header => {
        header.addEventListener('click', (e) => {
            if (e.target.classList.contains('column-resizer')) return;
            const sortField = header.dataset.sortField;
            if (!sortField) return;
            const url = new URL(window.location.href);
            let newDirection = 'asc';
            if (sortField === currentSortField) {
                newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
            }
            url.searchParams.set('sort', sortField);
            url.searchParams.set('direction', newDirection);
            window.location = url.toString();
        });
    });
});

function abrirModalEditar(id) {
    acaoAtual = 'editar';
    pedidoId = id;
    document.getElementById('modalTitle').textContent = 'Editar Pedido';
    document.getElementById('modalMessage').textContent = 'Para editar este pedido, insira a senha do administrador.';
    document.getElementById('btnConfirmar').textContent = 'Editar Pedido';
    document.getElementById('btnConfirmar').className = 'btn btn-primary';
    document.getElementById('modalConfirmacao').style.display = 'block';
    document.getElementById('senhaAdmin').focus();
}

function abrirModalExcluir(id) {
    acaoAtual = 'excluir';
    pedidoId = id;
    document.getElementById('modalTitle').textContent = 'Excluir Pedido';
    document.getElementById('modalMessage').textContent = 'ATENÇÃO: Esta ação é irreversível! Para excluir este pedido, insira a senha do administrador.';
    document.getElementById('btnConfirmar').textContent = 'Excluir Pedido';
    document.getElementById('btnConfirmar').className = 'btn btn-danger';
    document.getElementById('modalConfirmacao').style.display = 'block';
    document.getElementById('senhaAdmin').focus();
}

function abrirModalConfirmarComercial(id) {
    acaoAtual = 'confirmar_comercial';
    pedidoId = id;
    document.getElementById('modalTitle').textContent = 'Confirmar Pedido (Comercial)';
    document.getElementById('modalMessage').textContent = 'Para confirmar este pedido e liberá-lo para análise financeira, insira a senha do administrador.';
    document.getElementById('btnConfirmar').textContent = 'Confirmar Pedido';
    document.getElementById('btnConfirmar').className = 'btn btn-success';
    document.getElementById('modalConfirmacao').style.display = 'block';
    document.getElementById('senhaAdmin').focus();
}

function fecharModal() {
    document.getElementById('modalConfirmacao').style.display = 'none';
    document.getElementById('formSenha').reset();
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('loading').style.display = 'none';
    acaoAtual = '';
    pedidoId = null;
}

function confirmarAcao() {
    const senha = document.getElementById('senhaAdmin').value;
    const errorMessage = document.getElementById('errorMessage');
    const loading = document.getElementById('loading');
    const btnConfirmar = document.getElementById('btnConfirmar');
    const csrfTokenInput = document.querySelector('#formSenha input[name="csrf_token"]');
    const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';
    
    if (!senha) {
        errorMessage.textContent = 'Por favor, insira a senha.';
        errorMessage.style.display = 'block';
        return;
    }
    
    // Mostrar loading
    loading.style.display = 'block';
    btnConfirmar.disabled = true;
    errorMessage.style.display = 'none';
    
    let url = '';
    if (acaoAtual === 'editar') {
        url = `/pedidos/editar/${pedidoId}/confirmar`;
    } else if (acaoAtual === 'excluir') {
        url = `/pedidos/excluir/${pedidoId}/confirmar`;
    } else if (acaoAtual === 'confirmar_comercial') {
        url = `/pedidos/confirmar_comercial/${pedidoId}`;
    }
    
    const payload = new URLSearchParams({
        senha: senha,
    });
    if (csrfToken) {
        payload.append('csrf_token', csrfToken);
    }

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            ...(csrfToken ? {'X-CSRFToken': csrfToken} : {}),
        },
        body: payload,
    })
    .then(response => response.json())
    .then(data => {
        loading.style.display = 'none';
        btnConfirmar.disabled = false;
        
        if (data.success) {
            if (acaoAtual === 'editar') {
                fecharModal();
                const destino = data.redirect || `/pedidos/editar/${pedidoId}`;
                window.location.href = destino;
            } else if (acaoAtual === 'excluir') {
                fecharModal();
                const linha = document.getElementById(`linha-pedido-${pedidoId}`);
                if (linha) {
                    linha.classList.add('linha-removida');
                    setTimeout(() => {
                        linha.remove();
                        const tbody = document.querySelector('.pedidos-table tbody');
                        if (tbody && tbody.querySelectorAll('tr').length === 0) {
                            const vazio = document.createElement('tr');
                            vazio.innerHTML = '<td colspan="8">Nenhum pedido encontrado com os filtros aplicados.</td>';
                            tbody.appendChild(vazio);
                        }
                    }, 150);
                }
                if (typeof notificationSystem !== 'undefined') {
                    notificationSystem.success('Pedido excluído', data.message || 'Pedido excluído com sucesso!', 4000);
                } else {
                    console.log('Pedido excluído com sucesso!');
                }
            } else if (acaoAtual === 'confirmar_comercial') {
                fecharModal();
                window.location.reload();
                if (typeof notificationSystem !== 'undefined') {
                    notificationSystem.success('Pedido confirmado', data.message || 'Pedido confirmado com sucesso!', 4000);
                }
            }
        } else {
            errorMessage.textContent = data.message || 'Senha incorreta.';
            errorMessage.style.display = 'block';
        }
    })
    .catch(error => {
        loading.style.display = 'none';
        btnConfirmar.disabled = false;
        errorMessage.textContent = 'Erro ao processar a solicitação.';
        errorMessage.style.display = 'block';
        console.error('Erro:', error);
    });
}

// Fechar modal ao clicar fora dele
window.onclick = function(event) {
    const modal = document.getElementById('modalConfirmacao');
    if (event.target === modal) {
        fecharModal();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const tabela = document.querySelector('.pedidos-table');
    if (!tabela) return;

    const headers = tabela.querySelectorAll('th[data-column-index]');
    const columns = tabela.querySelectorAll('colgroup col');
    const filtro = document.getElementById('filtroPedidos');

    const applyColumnWidth = (columnIndex, width) => {
        if (columns.length && columns[columnIndex]) {
            columns[columnIndex].style.width = width + 'px';
        }
        tabela.querySelectorAll('thead th')[columnIndex].style.width = width + 'px';
        tabela.querySelectorAll('tbody tr').forEach((row) => {
            const cell = row.children[columnIndex];
            if (cell) cell.style.width = width + 'px';
        });
    };

    const autoFitColumn = (columnIndex) => {
        let maxWidth = 0;
        tabela.querySelectorAll('tr').forEach((row) => {
            const cell = row.children[columnIndex];
            if (!cell) return;
            const cellWidth = cell.scrollWidth + 20;
            if (cellWidth > maxWidth) maxWidth = cellWidth;
        });
        const targetWidth = Math.min(Math.max(maxWidth, 80), 600);
        applyColumnWidth(columnIndex, targetWidth);
    };

    const startManualResize = (event, columnIndex) => {
        event.preventDefault();
        const startX = event.pageX;
        const header = event.target.parentElement;
        const startWidth = header.offsetWidth;

        function onMouseMove(moveEvent) {
            const delta = moveEvent.pageX - startX;
            const newWidth = Math.max(80, startWidth + delta);
            applyColumnWidth(columnIndex, newWidth);
        }

        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    };

    headers.forEach((header, index) => {
        header.classList.add('resizable-header');
        const handle = document.createElement('span');
        handle.className = 'column-resizer';
        header.appendChild(handle);

        handle.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            startManualResize(e, index);
        });

        header.addEventListener('dblclick', (e) => {
            e.stopPropagation();
            autoFitColumn(index);
        });
    });

    if (filtro) {
        const rows = Array.from(tabela.querySelectorAll('tbody tr'));
        const aplicarFiltroRapido = (valor) => {
            const termo = (valor || '').trim().toLowerCase();
            rows.forEach((row) => {
                const texto = row.textContent.toLowerCase();
                row.style.display = texto.includes(termo) ? '' : 'none';
            });
        };
        filtro.addEventListener('input', (event) => {
            aplicarFiltroRapido(event.target.value);
        });
        if (filtro.value) {
            aplicarFiltroRapido(filtro.value);
        }
    }
});

// Lógica para filtros de data
document.addEventListener('DOMContentLoaded', function() {
    const mesAnoInput = document.getElementById('mes_ano');
    const dataInicioInput = document.getElementById('data_inicio');
    const dataFimInput = document.getElementById('data_fim');
    const filtroStatus = document.getElementById('filtroStatus');
    
    // Event listener para filtro de status
    if (filtroStatus) {
        filtroStatus.addEventListener('change', function() {
            this.form.submit();
        });
    }

    // Ao selecionar um mês/ano, limpa os campos de data e submete
    mesAnoInput.addEventListener('change', function() {
        if (this.value) {
            dataInicioInput.value = '';
            dataFimInput.value = '';
            this.form.submit();
        }
    });

    // Ao interagir com os campos de data, limpa o campo de mês/ano
    function limparMesAno() {
        mesAnoInput.value = '';
    }

    dataInicioInput.addEventListener('input', limparMesAno);
    dataFimInput.addEventListener('input', limparMesAno);
    
    // Event listeners para os botões de ação (CSP-compliant)
    const botoesConfirmar = document.querySelectorAll('[data-action="confirmar"]');
    console.log('Botões confirmar encontrados:', botoesConfirmar.length);
    botoesConfirmar.forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Botão confirmar clicado');
            const pedidoId = parseInt(this.dataset.pedidoId);
            console.log('Pedido ID:', pedidoId);
            abrirModalConfirmarComercial(pedidoId);
        });
    });


    const botoesEditar = document.querySelectorAll('[data-action="editar"]');
    console.log('Botões editar encontrados:', botoesEditar.length);
    botoesEditar.forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Botão editar clicado');
            const pedidoId = parseInt(this.dataset.pedidoId);
            abrirModalEditar(pedidoId);
        });
    });
    
    const botoesExcluir = document.querySelectorAll('[data-action="excluir"]');
    console.log('Botões excluir encontrados:', botoesExcluir.length);
    botoesExcluir.forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Botão excluir clicado');
            const pedidoId = parseInt(this.dataset.pedidoId);
            abrirModalExcluir(pedidoId);
        });
    });
    
    // Event listeners para botões do modal
    const btnFecharModal = document.getElementById('btnFecharModal');
    const btnCancelar = document.getElementById('btnCancelar');
    const btnConfirmar = document.getElementById('btnConfirmar');
    
    if (btnFecharModal) {
        btnFecharModal.addEventListener('click', fecharModal);
    }
    
    if (btnCancelar) {
        btnCancelar.addEventListener('click', fecharModal);
    }
    
    if (btnConfirmar) {
        btnConfirmar.addEventListener('click', confirmarAcao);
    }
    
    // Permitir confirmação com Enter no campo senha
    const senhaAdmin = document.getElementById('senhaAdmin');
    if (senhaAdmin) {
        senhaAdmin.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                confirmarAcao();
            }
        });
    }
});

</script>
{% endblock %}
