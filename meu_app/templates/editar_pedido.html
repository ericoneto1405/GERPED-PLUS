{% extends 'base.html' %}

{% block page_title %}Editar Pedido #{{ pedido.numero_exibicao }}{% endblock %}

{% block content %}
<div class="card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0"><i class="bi bi-pencil-square icon-text"></i>Editar Pedido #{{ pedido.numero_exibicao }}</h2>
        <a href="{{ url_for('pedidos.listar_pedidos') }}" class="btn btn-secondary"><i class="bi bi-arrow-left icon-text"></i>Voltar</a>
    </div>

    <style>
        .pedido-itens-header,
        .pedido-item-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
            width: 100%;
        }
        .pedido-col-produto { flex: 0 0 400px; max-width: 400px; }
        .pedido-col-qtd { width: 80px; }
        .pedido-col-preco,
        .pedido-col-compra { width: 90px; }
        .pedido-col-invest,
        .pedido-col-total { width: 120px; }
        .pedido-col-percent { width: 100px; }
        .pedido-col-acao { width: 34px; }
    </style>

    <div class="alert alert-info">
        <h5 class="alert-heading"><i class="bi bi-clipboard icon-text"></i>Informações do Pedido</h5>
        <p class="mb-1"><strong>Cliente:</strong> {{ pedido.cliente.nome }}</p>
        <p class="mb-1"><strong>Data de Criação:</strong>
            <span class="js-utc" data-utc="{{ pedido.data|datetime_utc_iso }}" data-format="DD/MM/YYYY [às] HH:mm">
                {{ pedido.data.strftime('%d/%m/%Y às %H:%M') }}
            </span>
        </p>
        <p class="mb-0"><strong>Status:</strong> <span class="badge bg-info text-dark">{{ pedido.status }}</span></p>
    </div>

    <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group mb-3">
            <label for="cliente_id" class="form-label"><strong>Cliente:</strong></label>
            <select name="cliente_id" id="cliente_id" class="form-control" required>
                {% for cliente in clientes %}
                    <option value="{{ cliente.id }}" {% if cliente.id == pedido.cliente_id %}selected{% endif %}>
                        {{ cliente.nome }} {% if cliente.fantasia %}({{ cliente.fantasia }}){% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>

        <hr>

    <h5><i class="bi bi-box-seam icon-text"></i>Itens do Pedido</h5>
    <div class="pedido-itens-header mb-2 text-secondary small fw-semibold" aria-hidden="true">
        <div class="pedido-col-produto">Produto</div>
        <div class="pedido-col-qtd">Qtd.</div>
        <div class="pedido-col-preco">Preço de venda</div>
        <div class="pedido-col-compra">Preço compra</div>
        <div class="pedido-col-invest">Investimento</div>
        <div class="pedido-col-total">Total item</div>
        <div class="pedido-col-percent">%</div>
        <div class="pedido-col-acao"></div>
    </div>
    <div id="items" class="mb-3">
        {% for item in pedido.itens %}
        <div class="pedido-item-row mb-2" data-item-row data-preco-compra="{{ item.produto.preco_medio_compra or 0 }}">
            <div class="pedido-col-produto">
                <select name="produto_id" class="form-control select2-ajax" required>
                    <option value="{{ item.produto.id }}" selected>{{ item.produto.nome }} {% if item.produto.codigo_interno %}({{ item.produto.codigo_interno }}){% endif %}</option>
                </select>
            </div>
            <div class="pedido-col-qtd">
                <input type="number" name="quantidade" class="form-control" placeholder="Qtd" value="{{ item.quantidade }}" min="1" required>
            </div>
            <div class="pedido-col-preco">
                <input type="text" name="preco_venda" class="form-control preco-input" placeholder="Preço venda" inputmode="decimal" data-requer-centavos="true" value="{{ item.preco_venda | replace('.', ',') }}" required>
            </div>
            <div class="pedido-col-compra">
                <input type="text" class="form-control" placeholder="Preço compra" data-field="preco-compra" readonly tabindex="-1" aria-label="Preço médio de compra">
            </div>
            <div class="pedido-col-invest">
                <input type="text" class="form-control" placeholder="Investimento" data-field="investimento" readonly tabindex="-1" aria-label="Investimento">
            </div>
            <div class="pedido-col-total">
                <input type="text" class="form-control total-item" placeholder="0,00" value="" readonly aria-label="Total do item">
            </div>
            <div class="pedido-col-percent">
                <input type="text" class="form-control text-center" data-field="percentual-item" value="0%" readonly tabindex="-1" aria-label="Percentual do investimento">
            </div>
            <div class="pedido-col-acao">
                <button type="button" class="btn btn-danger btn-sm" data-action="remove-item" aria-label="Remover item"><i class="bi bi-trash icon-text"></i></button>
            </div>
        </div>
        {% endfor %}
    </div>
        <button type="button" class="btn btn-info btn-sm" data-action="add-item"><i class="bi bi-plus-lg icon-text"></i>Adicionar Item</button>

        <hr class="mt-4">

        <div class="d-flex justify-content-between align-items-center">
            <div class="text-end">
                <div class="text-muted small">Total do pedido</div>
                <div id="totalPedido" class="fw-bold">R$ 0,00</div>
                <div class="text-muted small mt-2">Investimento</div>
                <div id="percentualInvestimento" class="fw-bold">0%</div>
            </div>
            <div class="text-end">
                <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-save icon-text"></i>Salvar Alterações</button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/select2/4.1.0-rc.0/css/select2.min.css') }}" />
<script nonce="{{ nonce }}" src="{{ url_for('static', filename='vendor/select2/4.1.0-rc.0/js/select2.min.js') }}"></script>
<script nonce="{{ nonce }}" src="{{ url_for('static', filename='vendor/select2/4.1.0-rc.0/js/i18n/pt-BR.js') }}"></script>
    
<script nonce="{{ nonce }}">
    function setupSelect2Ajax(selector) {
        try {
            if (typeof $ === 'undefined' || !$.fn.select2) {
                console.error('Select2 não está carregado.');
                return;
            }
            const $select = $(selector);
            $select.select2({
                placeholder: "Digite para buscar um produto...",
                width: '100%',
                language: 'pt-BR',
                ajax: {
                    url: "{{ url_for('produtos.api_produtos') }}",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return { q: params.term };
                    },
                    processResults: function (data) {
                        return { results: data.results };
                    },
                    cache: true
                },
                minimumInputLength: 1,
            });
            $select.on('select2:select', (event) => {
                const data = event?.params?.data || {};
                const row = $select.closest('[data-item-row]')[0];
                if (row) {
                    row.dataset.precoCompra = data.preco_medio_compra ?? 0;
                    calcularTotais();
                }
            });
        } catch (error) {
            console.error('Erro ao inicializar Select2:', error);
        }
    }

    function addItem() {
        try {
            const container = document.getElementById('items');
            if (!container) {
                console.error('Container #items não encontrado');
                return;
            }
            const itemBox = document.createElement('div');
            itemBox.className = 'pedido-item-row mb-2';
            itemBox.setAttribute('data-item-row', '');
            itemBox.dataset.precoCompra = '0';
            
            itemBox.innerHTML = `
                <div class="pedido-col-produto">
                    <select name="produto_id" class="form-control select2-ajax" required></select>
                </div>
                <div class="pedido-col-qtd">
                    <input type="number" name="quantidade" class="form-control" placeholder="Qtd" min="1" required>
                </div>
                <div class="pedido-col-preco">
                    <input type="text" name="preco_venda" class="form-control preco-input" placeholder="Preço venda" inputmode="decimal" data-requer-centavos="true" required>
                </div>
                <div class="pedido-col-compra">
                    <input type="text" class="form-control" placeholder="Preço compra" data-field="preco-compra" readonly tabindex="-1" aria-label="Preço médio de compra">
                </div>
                <div class="pedido-col-invest">
                    <input type="text" class="form-control" placeholder="Investimento" data-field="investimento" readonly tabindex="-1" aria-label="Investimento">
                </div>
                <div class="pedido-col-total">
                    <input type="text" class="form-control total-item" placeholder="0,00" value="" readonly aria-label="Total do item">
                </div>
                <div class="pedido-col-percent">
                    <input type="text" class="form-control text-center" data-field="percentual-item" value="0%" readonly tabindex="-1" aria-label="Percentual do investimento">
                </div>
                <div class="pedido-col-acao">
                    <button type="button" class="btn btn-danger btn-sm" data-action="remove-item" aria-label="Remover item"><i class="bi bi-trash icon-text"></i></button>
                </div>
            `;
            
            container.appendChild(itemBox);
            
            setupSelect2Ajax($(itemBox).find('.select2-ajax'));

        } catch (error) {
            console.error('Erro ao adicionar item:', error);
            alert('Ocorreu um erro ao adicionar o produto. Verifique o console para detalhes.');
        }
    }

    function formatBRL(number) {
        if (number === null || number === undefined || isNaN(number)) return 'R$ 0,00';
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(number);
    }

    function parsePrecoTexto(texto) {
        if (!texto) return 0;
        const normalizado = texto.replace(/\./g, '').replace(',', '.');
        const numero = parseFloat(normalizado);
        return Number.isNaN(numero) ? 0 : numero;
    }

    function calcularTotais() {
        const rows = document.querySelectorAll('[data-item-row]');
        let totalPedido = 0;
        let totalInvestimento = 0;
        rows.forEach(row => {
            const qtdInput = row.querySelector('input[name="quantidade"]');
            const precoInput = row.querySelector('input[name="preco_venda"]');
            const totalField = row.querySelector('.total-item');
            const precoCompraField = row.querySelector('[data-field="preco-compra"]');
            const investimentoField = row.querySelector('[data-field="investimento"]');
            const percentualItemField = row.querySelector('[data-field="percentual-item"]');
            const qtd = parseFloat(qtdInput?.value || 0);
            const preco = parsePrecoTexto(precoInput?.value || '');
            const precoCompra = parseFloat(row.dataset.precoCompra || 0) || 0;
            const totalItem = (isNaN(qtd) || isNaN(preco)) ? 0 : qtd * preco;
            const investimento = (isNaN(qtd) || isNaN(preco)) ? 0 : (preco - precoCompra) * qtd;
            totalPedido += totalItem;
            totalInvestimento += investimento;
            if (totalField) {
                totalField.value = formatBRL(totalItem);
            }
            if (precoCompraField) {
                precoCompraField.dataset.valor = String(precoCompra);
                precoCompraField.value = formatBRL(precoCompra);
            }
            if (investimentoField) {
                investimentoField.value = formatBRL(investimento);
            }
            if (percentualItemField) {
                const pctItem = totalItem > 0 ? (investimento / totalItem) * 100 : 0;
                percentualItemField.value = `${pctItem.toFixed(1)}%`;
            }
        });
        const totalLabel = document.getElementById('totalPedido');
        if (totalLabel) {
            totalLabel.textContent = formatBRL(totalPedido);
        }
        const percentualLabel = document.getElementById('percentualInvestimento');
        if (percentualLabel) {
            const pct = totalPedido > 0 ? (totalInvestimento / totalPedido) * 100 : 0;
            percentualLabel.textContent = `${pct.toFixed(1)}%`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const addItemButton = document.querySelector('[data-action="add-item"]');
        const itemsContainer = document.getElementById('items');

        if (addItemButton) {
            addItemButton.addEventListener('click', addItem);
        }

        itemsContainer?.addEventListener('click', (event) => {
            const removeBtn = event.target.closest('[data-action="remove-item"]');
            if (removeBtn) {
                removeBtn.closest('[data-item-row]')?.remove();
                calcularTotais();
            }
        });

        calcularTotais();

        itemsContainer?.addEventListener('input', (e) => {
            if (e.target.matches('input[name="quantidade"], input[name="preco_venda"]')) {
                calcularTotais();
            }
        });
    });

    $(document).ready(function() {
        try {
            if (typeof $ !== 'undefined' && $.fn.select2) {
                $('select[name="cliente_id"]').select2({ width: '100%', language: 'pt-BR' });

                // Inicializa o Select2 para os produtos já existentes no pedido
                $('.select2-ajax').each(function() {
                    setupSelect2Ajax(this);
                });
            }
            
            if (typeof CurrencyFormatter !== 'undefined') {
                CurrencyFormatter.initializeInputs();
            }
        } catch (error) {
            console.error('Erro na inicialização do formulário de edição:', error);
        }
    });
</script>
{% endblock %}
