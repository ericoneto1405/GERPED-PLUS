{% extends "base.html" %}

{% block title %}Controle de Estoque - GERPED{% endblock %}
{% block page_title %}Controle de Estoque{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <h2>Controle de Estoque</h2>
        <div class="header-actions">
            <a href="{{ url_for('estoques.novo_estoque') }}" class="btn btn-primary">
                <span class="icon"><i class="bi bi-plus-lg icon-text"></i></span>
                Adicionar ao Estoque
            </a>
        </div>
    </div>
</div>

<div class="content-section">
    <div class="table-container">
        <div class="table-toolbar">
            <div class="input-group shadow-sm" style="max-width: 360px;">
                <span class="input-group-text bg-white">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="search" id="filtroEstoques" class="form-control" placeholder="Buscar por produto, conferente, status..." />
            </div>
            <small class="text-muted">Clique nos títulos para ordenar e utilize a busca para filtrar rapidamente.</small>
        </div>
        <table class="data-table estoques-table">
            <thead>
                <tr>
                    <th data-column-index="0">Descrição</th>
                    <th data-column-index="1">Data de Modificação</th>
                    <th data-column-index="2">Conferente</th>
                    <th data-column-index="3">Status</th>
                    <th data-column-index="4">Estoque Atual</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for estoque in estoques %}
                <tr>
                    <td>
                        <div class="product-info">
                            <a href="{{ url_for('estoques.historico_movimentacao', produto_id=estoque.produto.id) }}" 
                               target="_blank" class="product-link" title="Ver histórico de movimentação">
                                <span class="product-name">{{ estoque.produto.nome }}</span>
                                {% if estoque.produto.codigo_interno %}
                                <span class="product-code">Código: {{ estoque.produto.codigo_interno }}</span>
                                {% endif %}
                                <span class="history-icon"><i class="bi bi-bar-chart icon-text"></i></span>
                            </a>
                        </div>
                    </td>
                    <td>{{ estoque.data_modificacao.strftime('%d/%m/%Y %H:%M') if estoque.data_modificacao else 'N/A' }}</td>
                    <td>{{ estoque.conferente }}</td>
                    <td>
                        <span class="status-badge status-{{ estoque.status.lower().replace(' ', '-') }}">
                            {{ estoque.status }}
                        </span>
                    </td>
                    <td>
                        <span class="quantity-badge">{{ estoque.quantidade }}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="{{ url_for('estoques.editar_estoque', id=estoque.id) }}" class="btn-icon btn-edit" title="Editar">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </a>
                            <a href="{{ url_for('estoques.excluir_estoque', id=estoque.id) }}" class="btn-icon btn-delete" title="Excluir" 
                               onclick="return confirm('Tem certeza que deseja excluir este registro de estoque?')">
                                <svg class="icon-svg" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="no-data">
                        <div class="empty-state">
                            <span class="empty-icon"><i class="bi bi-box-seam icon-text"></i></span>
                            <p>Nenhum registro de estoque encontrado</p>
                            <a href="{{ url_for('estoques.novo_estoque') }}" class="btn btn-primary">Criar primeiro registro</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.product-link {
    text-decoration: none;
    color: inherit;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.product-link:hover {
    background-color: #f8f9fa;
    color: #007bff;
    text-decoration: none;
}

.product-link .history-icon {
    font-size: 0.9em;
    opacity: 0.7;
    transition: opacity 0.2s ease;
}

.product-link:hover .history-icon {
    opacity: 1;
}

.product-name {
    font-weight: 500;
}

.product-code {
    font-size: 0.85em;
    color: #666;
    margin-left: 8px;
}

.table-toolbar {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: 12px;
}

.estoques-table thead {
    background: #f8f9fa;
}

.estoques-table th,
.estoques-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #f1f3f4;
}

.estoques-table th[data-column-index] {
    cursor: pointer;
    user-select: none;
    position: relative;
    font-weight: 600;
}

.estoques-table th[data-column-index] .sort-indicator {
    font-size: 0.7rem;
    margin-left: 6px;
    color: #adb5bd;
}

.estoques-table th.sorted-asc,
.estoques-table th.sorted-desc {
    color: #0d6efd;
}
</style>
{% endblock %}

{% block scripts %}
<script nonce="{{ nonce }}">
$(document).ready(function() {
    // Inicializar tooltips
    $('[title]').tooltip();
    
    // Adicionar classes para estilização
    $('.quantity-badge').each(function() {
        var quantity = parseInt($(this).text());
        if (quantity <= 10) {
            $(this).addClass('low-stock');
        } else if (quantity <= 50) {
            $(this).addClass('medium-stock');
        } else {
            $(this).addClass('high-stock');
        }
    });
});

document.addEventListener('DOMContentLoaded', () => {
    const tabela = document.querySelector('.estoques-table');
    if (!tabela) return;

    const tbody = tabela.querySelector('tbody');
    const headers = tabela.querySelectorAll('th[data-column-index]');
    const filtro = document.getElementById('filtroEstoques');
    let currentSort = { index: null, direction: 'asc' };

    const parseValue = (cell, index) => {
        if (index === 1) {
            // datas no formato dd/mm/yyyy hh:mm
            const text = cell.textContent.trim();
            const [data, hora] = text.split(' ');
            if (!data || !hora) return text.toLowerCase();
            const [dia, mes, ano] = data.split('/');
            const value = `${ano}-${mes}-${dia} ${hora}`;
            return value;
        }
        if (index === 4) {
            const number = parseInt(cell.textContent.trim(), 10);
            return Number.isNaN(number) ? 0 : number;
        }
        return cell.textContent.trim().toLowerCase();
    };

    const applySortIndicators = () => {
        headers.forEach((header) => {
            header.classList.remove('sorted-asc', 'sorted-desc');
            let indicator = header.querySelector('.sort-indicator');
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.className = 'sort-indicator';
                header.appendChild(indicator);
            }
            indicator.innerHTML = '';
        });

        const target = headers[currentSort.index];
        if (!target) return;
        let indicator = target.querySelector('.sort-indicator');
        if (!indicator) {
            indicator = document.createElement('span');
            indicator.className = 'sort-indicator';
            target.appendChild(indicator);
        }
        target.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
        indicator.innerHTML = currentSort.direction === 'asc'
            ? '<i class="bi bi-caret-up-fill"></i>'
            : '<i class="bi bi-caret-down-fill"></i>';
    };

    const sortRows = (index, direction) => {
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((rowA, rowB) => {
            const a = parseValue(rowA.children[index], index);
            const b = parseValue(rowB.children[index], index);

            if (typeof a === 'number' && typeof b === 'number') {
                return direction === 'asc' ? a - b : b - a;
            }
            return direction === 'asc'
                ? String(a).localeCompare(String(b))
                : String(b).localeCompare(String(a));
        });

        rows.forEach((row) => tbody.appendChild(row));
        applySortIndicators();
    };

    headers.forEach((header, index) => {
        header.addEventListener('click', () => {
            const direction = (currentSort.index === index && currentSort.direction === 'asc') ? 'desc' : 'asc';
            currentSort = { index, direction };
            sortRows(index, direction);
        });
    });

    if (filtro) {
        filtro.addEventListener('input', (event) => {
            const termo = event.target.value.trim().toLowerCase();
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row) => {
                const texto = row.textContent.toLowerCase();
                row.style.display = texto.includes(termo) ? '' : 'none';
            });
        });
    }
});
</script>
{% endblock %}
